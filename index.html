<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKEJTY - 3 ZDJĘCIA</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto+Mono:wght@300;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"> 
    
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Skejty" />
    <link rel="manifest" href="/site.webmanifest" />
    
    <style>
        /* --- ZACHOWANE ZMIENNE I STYLE Z INDEX(6) --- */
        :root {
            --neon-green: #39ff14; --neon-pink: #ff00ff; --neon-blue: #00f3ff;
            --neon-red: #ff3131; --neon-orange: #ffaa00; --main-bg: #f0f0f0; 
            --sidebar-bg: rgba(240, 240, 240, 0.95); --text-color: #111;
            --card-bg: white; --form-bg: white; --comment-bg: #f4f4f4; --shadow-color: rgba(0,0,0,0.1);
        }

        body.dark-mode {
            --main-bg: #1a1a2e; --sidebar-bg: rgba(26, 26, 46, 0.98);
            --text-color: #f0f0f0; --card-bg: #2d2d4d; --form-bg: #3e3e6e;
            --comment-bg: #4a4a7d; --shadow-color: rgba(0, 243, 255, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; cursor: none; }
        body { font-family: 'Orbitron', sans-serif; background-color: var(--main-bg); color: var(--text-color); overflow-x: hidden; height: 100vh; transition: background-color 0.5s; }
        
        #cursor {
            position: fixed; width: 20px; height: 20px; border: 2px solid var(--neon-pink); border-radius: 50%;
            pointer-events: none; z-index: 9999; transform: translate(-50%, -50%);
            transition: width 0.2s, height 0.2s, background 0.2s; mix-blend-mode: difference;
        }
        #cursor.hovered { width: 50px; height: 50px; background: rgba(255, 0, 255, 0.2); border-color: var(--neon-green); mix-blend-mode: normal; }

        /* --- NOWE STYLE DLA GALERII 3 ZDJĘĆ (ZGODNIE ZE ZDJĘCIEM) --- */
        .spot-images-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
            height: 110px; /* Stała wysokość rzędu zdjęć */
        }

        .spot-images-grid img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid var(--neon-blue);
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
        }

        .spot-images-grid img:hover {
            transform: scale(1.03);
            border-color: var(--neon-pink);
        }

        /* Formularz - layout dodawania */
        .upload-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-top: 10px;
        }
        .upload-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .preview-mini {
            width: 100%;
            aspect-ratio: 1;
            border: 1px dashed var(--neon-blue);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: rgba(0,0,0,0.1);
        }
        .preview-mini img { width: 100%; height: 100%; object-fit: cover; }
        .upload-box input { font-size: 10px; width: 100%; color: var(--text-color); }

        /* --- RESZTA STYLI UI Z INDEX(6) --- */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--main-bg); display: flex; justify-content: center; align-items: center; z-index: 10000; flex-direction: column; }
        .skate-wheel { width: 80px; height: 80px; border: 8px solid var(--neon-green); border-top: 8px solid var(--neon-pink); border-radius: 50%; animation: spin 0.5s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .app-container { display: grid; grid-template-columns: 400px 1fr; height: 100vh; opacity: 0; }
        .sidebar { background: var(--sidebar-bg); backdrop-filter: blur(10px); border-right: 2px solid var(--neon-pink); padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        #map-container { position: relative; width: 100%; height: 100%; }
        #map { width: 100%; height: 100%; z-index: 1; }

        .btn-neon { font-family: 'Orbitron'; font-weight: bold; padding: 10px; margin: 5px 0; border: 2px solid; border-radius: 5px; cursor: pointer; width: 100%; background: transparent; transition: 0.3s; }
        .btn-green { color: var(--neon-green); border-color: var(--neon-green); }
        .btn-orange { color: var(--neon-orange); border-color: var(--neon-orange); }
        .btn-red { color: var(--neon-red); border-color: var(--neon-red); }
        .btn-blue { color: var(--neon-blue); border-color: var(--neon-blue); }
        .btn-neon:hover { background: white; color: black; box-shadow: 0 0 15px var(--neon-pink); }

        .search-overlay { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; z-index: 1000; width: 90%; max-width: 350px; }
        .search-overlay input { flex-grow: 1; padding: 10px; background: rgba(17,17,17,0.8); color: white; border: 2px solid var(--neon-blue); border-radius: 5px; }

        #spot-form { display: none; position: fixed; bottom: 120px; right: 20px; z-index: 2000; width: 350px; background: var(--form-bg); padding: 15px; border: 2px solid var(--neon-pink); box-shadow: 0 5px 20px rgba(0,0,0,0.6); }
        .fab { position: fixed; bottom: 40px; right: 20px; width: 60px; height: 60px; background: var(--neon-pink); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 30px; cursor: pointer; z-index: 2000; }

        .spot-card { background: var(--card-bg); border: 2px solid var(--neon-pink); border-radius: 10px; padding: 15px; margin-bottom: 20px; }
        .bust-level { padding: 4px 8px; border-radius: 3px; font-weight: bold; font-size: 0.8rem; }
        .bust-safe { background: var(--neon-green); color: black; }
        .bust-medium { background: var(--neon-orange); color: black; }
        .bust-high { background: var(--neon-red); color: white; }

        #lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; justify-content: center; align-items: center; }
        #lightbox img { max-width: 90%; max-height: 90%; border: 2px solid white; }

        @media (max-width: 768px) {
            .app-container { grid-template-columns: 1fr; }
            .sidebar { position: fixed; bottom: 60px; width: 100%; height: 50vh; z-index: 5000; transform: translateY(100%); transition: 0.5s; }
            .sidebar.active { transform: translateY(0); }
            .mobile-nav { display: flex; position: fixed; bottom: 0; width: 100%; height: 60px; background: #111; justify-content: space-around; align-items: center; border-top: 2px solid var(--neon-pink); z-index: 6000; }
            .nav-item { color: #ccc; font-size: 0.7rem; display: flex; flex-direction: column; align-items: center; }
        }
    </style>
</head>
<body class="dark-mode">
    <div id="cursor"></div>
    <div id="loader"><div class="skate-wheel"></div><h2 style="margin-top:20px;">SKEJTY...</h2></div>
    <div id="lightbox" onclick="this.style.display='none'"><img id="lightbox-img"></div>

    <div class="app-container">
        <div class="sidebar" id="mainSidebar">
            <h1>SKEJ<span style="color:var(--neon-pink)">TY</span></h1>
            
            <div id="authContent" class="sidebar-section active">
                <div id="authStatus">Ładowanie...</div>
                <button class="btn-neon btn-green" id="showLoginBtn">Zaloguj</button>
                <button class="btn-neon btn-orange" id="showRegisterBtn">Rejestruj</button>
                <button class="btn-neon btn-red" id="logoutBtn" style="display:none;">Wyloguj</button>
                <div id="loginForm" style="display:none; margin-top:10px;">
                    <input type="email" id="loginEmail" placeholder="Email" style="width:100%; padding:8px; margin-bottom:5px;">
                    <input type="password" id="loginPassword" placeholder="Hasło" style="width:100%; padding:8px; margin-bottom:5px;">
                    <button class="btn-neon btn-green" onclick="handleLogin()">WEJDŹ</button>
                </div>
            </div>

            <div id="spotsListContent" class="sidebar-section">
                <h3>Lista Spotów (<span id="spotCount">0</span>)</h3>
                <div id="spotsList"></div>
            </div>
        </div>

        <div id="map-container">
            <div id="map"></div>
            
            <div class="search-overlay">
                <input type="text" id="citySearchInput" placeholder="Szukaj miasta...">
                <button class="btn-neon btn-blue" id="citySearchBtn" style="width:auto; margin:0;">OK</button>
            </div>

            <div class="fab" id="addSpotFab">+</div>

            <div id="spot-form">
                <div style="text-align:right; cursor:pointer; color:var(--neon-red); font-size:1.5rem;" onclick="toggleForm(false)">&times;</div>
                <input type="text" id="spotName" placeholder="Nazwa spota" style="width:100%; padding:8px; margin-bottom:10px;">
                <textarea id="spotDesc" placeholder="Opis..." style="width:100%; padding:8px; margin-bottom:10px;"></textarea>
                
                <select id="spotBust" style="width:100%; padding:8px; margin-bottom:10px;">
                    <option value="safe">Bezpiecznie</option>
                    <option value="medium">Średni Przypał</option>
                    <option value="high">Duży Przypał</option>
                </select>

                <label style="font-size:0.7rem; font-weight:bold; color:var(--neon-blue);">ZDJĘCIA (MAX 3):</label>
                <div class="upload-row">
                    <div class="upload-box">
                        <div class="preview-mini" id="p1"><span>1</span></div>
                        <input type="file" id="f1" accept="image/*" onchange="processImage(this, 'p1')">
                    </div>
                    <div class="upload-box">
                        <div class="preview-mini" id="p2"><span>2</span></div>
                        <input type="file" id="f2" accept="image/*" onchange="processImage(this, 'p2')">
                    </div>
                    <div class="upload-box">
                        <div class="preview-mini" id="p3"><span>3</span></div>
                        <input type="file" id="f3" accept="image/*" onchange="processImage(this, 'p3')">
                    </div>
                </div>

                <input type="hidden" id="spotLat"><input type="hidden" id="spotLng">
                <button class="btn-neon btn-green" id="saveSpotBtn" style="margin-top:15px;">ZAPISZ SPOT</button>
            </div>
        </div>
    </div>

    <div class="mobile-nav">
        <div class="nav-item" onclick="switchSection('auth')"><i class="fas fa-user"></i><span>Konto</span></div>
        <div class="nav-item" onclick="switchSection('map')"><i class="fas fa-map"></i><span>Mapa</span></div>
        <div class="nav-item" onclick="switchSection('spotsList')"><i class="fas fa-list"></i><span>Spoty</span></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // === CONFIG FIREBASE (Z TWOJEGO PLIKU) ===
        const firebaseConfig = {
            apiKey: "AIzaSyCCxW6X7MJlWPfxP_6I8FlLc7Vp2wiR69Q",
            authDomain: "skejspoty.firebaseapp.com",
            projectId: "skejspoty",
            storageBucket: "skejspoty.firebasestorage.app",
            messagingSenderId: "1067851773136",
            appId: "1:1067851773136:web:39bdc7f7af34cbbf94dad5"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const spotsCol = db.collection('spots');

        let currentUser = null;
        let spots = [];
        let markers = [];
        let editingId = null;

        // --- MAPA I WARSTWY (ZACHOWANE) ---
        const googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{subdomains:['mt0','mt1','mt2','mt3']});
        const googleHybrid = L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}',{subdomains:['mt0','mt1','mt2','mt3']});
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');

        const map = L.map('map', { center: [52.2297, 21.0122], zoom: 6, layers: [googleStreets] });
        L.control.layers({ "Google": googleStreets, "Satelita": googleHybrid, "OSM": osm }).addTo(map);

        // --- SYSTEM KOMPRESJI ZDJĘĆ (NOWY SYSTEM BASE64) ---
        function processImage(input, previewId) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    const max = 800; // Kompresja do max 800px

                    if (width > height && width > max) { height *= max / width; width = max; }
                    else if (height > max) { width *= max / height; height = max; }

                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7); // 70% jakości
                    document.getElementById(previewId).innerHTML = `<img src="${compressedBase64}">`;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- LOGIKA FORMULARZA ---
        function toggleForm(show, lat, lng) {
            const form = document.getElementById('spot-form');
            form.style.display = show ? 'block' : 'none';
            if(show && lat) {
                document.getElementById('spotLat').value = lat;
                document.getElementById('spotLng').value = lng;
            }
            if(!show) resetForm();
        }

        function resetForm() {
            editingId = null;
            document.getElementById('spotName').value = '';
            document.getElementById('spotDesc').value = '';
            ['f1','f2','f3'].forEach(id => document.getElementById(id).value = '');
            ['p1','p2','p3'].forEach((id, i) => document.getElementById(id).innerHTML = `<span>${i+1}</span>`);
            document.getElementById('saveSpotBtn').innerText = 'ZAPISZ SPOT';
        }

        document.getElementById('addSpotFab').onclick = () => {
            alert("Kliknij na mapę, aby wybrać miejsce!");
            map.once('click', e => toggleForm(true, e.latlng.lat, e.latlng.lng));
        };

        document.getElementById('saveSpotBtn').onclick = async () => {
            if(!currentUser) return alert("Zaloguj się!");
            
            const imgs = [];
            for(let i=1; i<=3; i++) {
                const imgTag = document.querySelector(`#p${i} img`);
                if(imgTag) imgs.push(imgTag.src);
            }

            const data = {
                name: document.getElementById('spotName').value,
                desc: document.getElementById('spotDesc').value,
                bust: document.getElementById('spotBust').value,
                lat: parseFloat(document.getElementById('spotLat').value),
                lng: parseFloat(document.getElementById('spotLng').value),
                images: imgs, // Tablica zdjęć Base64
                author: currentUser.uid,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if(editingId) await spotsCol.doc(editingId).update(data);
            else await spotsCol.add(data);
            
            toggleForm(false);
        };

        // --- RENDEROWANIE KART (ZGODNIE ZE ZDJĘCIEM) ---
        function createCard(spot) {
            const card = document.createElement('div');
            card.className = 'spot-card';
            
            const bustClass = spot.bust === 'safe' ? 'bust-safe' : (spot.bust === 'medium' ? 'bust-medium' : 'bust-high');
            
            // Grid 3 kolumny dla zdjęć
            let galleryHtml = '<div class="spot-images-grid">';
            for(let i=0; i<3; i++) {
                const src = (spot.images && spot.images[i]) ? spot.images[i] : 'https://via.placeholder.com/150?text=BRAK';
                galleryHtml += `<img src="${src}" onclick="openLightbox('${src}')">`;
            }
            galleryHtml += '</div>';

            card.innerHTML = `
                ${galleryHtml}
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="color:var(--neon-blue)">${spot.name}</h3>
                    <span class="bust-level ${bustClass}">${spot.bust.toUpperCase()}</span>
                </div>
                <p style="font-size:0.8rem; margin:10px 0; color:var(--text-color); opacity:0.8;">${spot.desc}</p>
                <div style="display:flex; gap:5px;">
                    <button class="btn-neon btn-blue" style="font-size:0.7rem;" onclick="map.flyTo([${spot.lat}, ${spot.lng}], 17)">MAPA</button>
                    ${currentUser && currentUser.uid === spot.author ? `
                        <button class="btn-neon btn-orange" style="font-size:0.7rem;" onclick="editSpot('${spot.id}')">EDYTUJ</button>
                        <button class="btn-neon btn-red" style="font-size:0.7rem;" onclick="deleteSpot('${spot.id}')">USUŃ</button>
                    ` : ''}
                </div>
            `;
            return card;
        }

        window.openLightbox = (src) => {
            document.getElementById('lightbox-img').src = src;
            document.getElementById('lightbox').style.display = 'flex';
        };

        window.editSpot = (id) => {
            const spot = spots.find(s => s.id === id);
            editingId = id;
            document.getElementById('spotName').value = spot.name;
            document.getElementById('spotDesc').value = spot.desc;
            document.getElementById('spotBust').value = spot.bust;
            document.getElementById('spotLat').value = spot.lat;
            document.getElementById('spotLng').value = spot.lng;
            
            if(spot.images) {
                spot.images.forEach((src, i) => {
                    document.getElementById('p' + (i+1)).innerHTML = `<img src="${src}">`;
                });
            }

            document.getElementById('saveSpotBtn').innerText = 'ZAKTUALIZUJ';
            toggleForm(true);
        };

        window.deleteSpot = async (id) => { if(confirm("Usunąć?")) await spotsCol.doc(id).delete(); };

        // --- OBSŁUGA DANYCH I AUTH (ZACHOWANE) ---
        spotsCol.onSnapshot(snap => {
            spots = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
            const list = document.getElementById('spotsList');
            list.innerHTML = '';
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            spots.forEach(spot => {
                list.appendChild(createCard(spot));
                const m = L.marker([spot.lat, spot.lng]).addTo(map).bindPopup(spot.name);
                markers.push(m);
            });
            document.getElementById('spotCount').innerText = spots.length;
        });

        auth.onAuthStateChanged(user => {
            currentUser = user;
            document.getElementById('authStatus').innerText = user ? `Hej, ${user.email}` : "Zaloguj się";
            document.getElementById('logoutBtn').style.display = user ? 'block' : 'none';
            document.getElementById('showLoginBtn').style.display = user ? 'none' : 'block';
            document.getElementById('showRegisterBtn').style.display = user ? 'none' : 'block';
        });

        window.handleLogin = () => {
            const e = document.getElementById('loginEmail').value;
            const p = document.getElementById('loginPassword').value;
            auth.signInWithEmailAndPassword(e, p).catch(err => alert(err.message));
        };

        document.getElementById('citySearchBtn').onclick = async () => {
            const q = document.getElementById('citySearchInput').value;
            if(!q) return;
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
            const data = await res.json();
            if(data[0]) map.flyTo([data[0].lat, data[0].lon], 13);
        };

        function switchSection(target) {
            document.querySelectorAll('.sidebar-section').forEach(s => s.classList.remove('active'));
            document.getElementById(target + 'Content').classList.add('active');
            if(window.innerWidth <= 768) { document.getElementById('mainSidebar').classList.toggle('active', target !== 'map'); }
        }

        window.onload = () => {
            gsap.to('#loader', { opacity: 0, duration: 1, onComplete: () => document.getElementById('loader').style.display = 'none' });
            gsap.to('.app-container', { opacity: 1, duration: 1 });
        };

        const cursor = document.getElementById('cursor');
        document.onmousemove = e => { cursor.style.left = e.clientX+'px'; cursor.style.top = e.clientY+'px'; };
    </script>
</body>
</html>
