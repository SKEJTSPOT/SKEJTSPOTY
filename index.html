<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKEJTY </title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto+Mono:wght@300;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"> 
    
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Skejty" />
    <link rel="manifest" href="/site.webmanifest" />
    
    <style>
        /* --- ZMIENNE KOLORÓW --- */
        :root {
            --color-neon-blue: #00FFFF;
            --color-dark-blue: #0000FF;
            --color-dark: #121212;
            --color-medium-dark: #1e1e1e;
            --color-light-grey: #e0e0e0;
            --color-white: #ffffff;
            --color-accent-pink: #FF00FF;
        }

        /* --- GLOBALNE --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Orbitron', sans-serif;
            color: var(--color-light-grey);
            cursor: none; /* Ukrywa standardowy kursor */
        }
        
        body {
            background-color: var(--color-dark);
            overflow: hidden; /* Ukrywa paski przewijania, bo mapa jest pełnoekranowa */
            height: 100vh;
        }

        /* --- LOADER --- */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-dark);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        #loader h1 {
            font-size: 2.5rem;
            color: var(--color-neon-blue);
            text-shadow: 0 0 10px var(--color-neon-blue);
        }

        /* --- APP CONTAINER --- */
        .app-container {
            opacity: 0; /* Zaczynamy od ukrycia, by pokazać po załadowaniu */
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* --- MAPA --- */
        #map {
            flex-grow: 1;
            height: 100%;
            z-index: 10;
        }

        /* --- LEAFLET MODYFIKACJE --- */
        .leaflet-container {
            background-color: var(--color-medium-dark) !important;
        }
        
        .leaflet-control-attribution a, .leaflet-control-zoom a, .leaflet-control-scale-line {
            color: var(--color-neon-blue) !important;
            background-color: var(--color-medium-dark) !important;
            border: 1px solid var(--color-neon-blue) !important;
            box-shadow: 0 0 5px var(--color-neon-blue) !important;
        }
        
        .leaflet-control-zoom a:hover, .leaflet-control-zoom-in:hover, .leaflet-control-zoom-out:hover {
            background-color: var(--color-dark-blue) !important;
            color: var(--color-white) !important;
        }

        /* --- MARKER --- */
        .spot-marker {
            width: 24px;
            height: 24px;
            background-color: var(--color-accent-pink);
            border-radius: 50%;
            border: 2px solid var(--color-white);
            box-shadow: 0 0 10px var(--color-accent-pink);
            transform: translate(-50%, -50%);
            display: block;
        }

        /* --- POPUP --- */
        .leaflet-popup-content-wrapper {
            background: var(--color-medium-dark) !important;
            color: var(--color-light-grey) !important;
            border: 2px solid var(--color-neon-blue) !important;
            box-shadow: 0 0 15px var(--color-neon-blue) !important;
            padding: 15px !important;
            border-radius: 8px !important;
        }

        .leaflet-popup-tip {
            background: var(--color-neon-blue) !important;
            border: none !important;
        }
        
        .leaflet-popup-content {
            width: 300px !important;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Roboto Mono', monospace !important;
        }

        .popup-header {
            color: var(--color-accent-pink);
            font-size: 1.2rem;
            margin-bottom: 5px;
            text-shadow: 0 0 5px var(--color-accent-pink);
        }
        
        .popup-tags, .popup-author {
            font-size: 0.8rem;
            margin-top: 5px;
        }
        
        .popup-tags span {
            display: inline-block;
            background-color: var(--color-dark-blue);
            color: var(--color-white);
            padding: 2px 5px;
            margin: 2px;
            border-radius: 3px;
            font-family: 'Roboto Mono', monospace;
        }

        .popup-image {
            width: 100%;
            height: auto;
            max-height: 200px;
            object-fit: cover;
            margin-top: 10px;
            border: 1px solid var(--color-light-grey);
            border-radius: 4px;
        }
        
        /* --- SIDEBAR --- */
        #sidebar {
            width: 350px;
            min-width: 350px;
            background-color: var(--color-dark);
            border-left: 2px solid var(--color-neon-blue);
            padding: 20px;
            display: flex;
            flex-direction: column;
            z-index: 20;
            overflow-y: auto;
            position: relative;
        }
        
        @media (max-width: 768px) {
            #sidebar {
                position: absolute;
                top: 0;
                right: 0;
                height: 100%;
                transform: translateX(100%);
                transition: transform 0.3s ease-out;
            }
            #sidebar.open {
                transform: translateX(0);
            }
        }
        
        /* --- KURSOR --- */
        #cursor {
            position: fixed;
            width: 20px;
            height: 20px;
            border: 2px solid var(--color-neon-blue);
            border-radius: 50%;
            pointer-events: none;
            transform: translate(-50%, -50%);
            transition: width 0.3s ease, height 0.3s ease, border-radius 0.3s ease;
            mix-blend-mode: difference; /* Efekt "odwrócenia koloru" */
            z-index: 10000;
        }

        #cursor.hovered {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--color-accent-pink);
            border: none;
            opacity: 0.8;
        }

        /* --- FORMULARZ --- */
        #spotForm, #authSection {
            background-color: var(--color-medium-dark);
            padding: 15px;
            border: 1px solid var(--color-accent-pink);
            border-radius: 8px;
            margin-top: 20px;
            display: none; /* Domyślnie ukryty */
            font-family: 'Roboto Mono', monospace;
        }

        #spotForm.open, #authSection.open {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: var(--color-neon-blue);
            font-family: 'Roboto Mono', monospace;
            font-size: 0.9rem;
        }

        input[type="text"], input[type="number"], input[type="file"], textarea {
            width: 100%;
            padding: 8px;
            background-color: var(--color-dark);
            border: 1px solid var(--color-neon-blue);
            color: var(--color-light-grey);
            border-radius: 4px;
            font-family: 'Roboto Mono', monospace;
            font-size: 1rem;
        }
        
        textarea {
            resize: vertical;
        }

        /* Sekcja Tagów */
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .tag-checkbox {
            display: none;
        }

        .tag-label {
            padding: 5px 10px;
            border: 1px solid var(--color-neon-blue);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8rem;
            color: var(--color-neon-blue);
            font-family: 'Roboto Mono', monospace;
        }

        .tag-checkbox:checked + .tag-label {
            background-color: var(--color-accent-pink);
            border-color: var(--color-accent-pink);
            color: var(--color-white);
            box-shadow: 0 0 8px var(--color-accent-pink);
        }

        /* --- STYLIZACJA NAGŁÓWKA/NAVIGACJI --- */
        #navHeader {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed var(--color-accent-pink);
        }

        #navHeader h1 {
            font-size: 2.5rem;
            color: var(--color-accent-pink);
            text-shadow: 0 0 10px var(--color-accent-pink);
            font-weight: 900;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }
        
        button {
            padding: 8px 15px;
            background-color: var(--color-neon-blue);
            color: var(--color-dark);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
        }

        button:hover {
            background-color: var(--color-dark-blue);
            color: var(--color-white);
            box-shadow: 0 0 10px var(--color-neon-blue);
        }

        /* --- NOTYFIKACJE --- */
        #notificationContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 50;
        }

        .notification {
            background-color: var(--color-medium-dark);
            color: var(--color-light-grey);
            padding: 10px 20px;
            margin-bottom: 10px;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            transform: translateY(-20px);
            font-family: 'Roboto Mono', monospace;
        }

        .notification.info {
            border-left: 4px solid var(--color-neon-blue);
        }
        .notification.error {
            border-left: 4px solid var(--color-accent-pink);
            color: var(--color-accent-pink);
        }
        .notification.success {
            border-left: 4px solid #00FF00;
            color: #00FF00;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* --- Sekcja Autoryzacji --- */
        #loginForm, #registerForm {
            margin-top: 10px;
            border-top: 1px dashed var(--color-neon-blue);
            padding-top: 15px;
        }
        
        .auth-toggle {
            display: block;
            text-align: center;
            margin-top: 10px;
            color: var(--color-neon-blue);
            font-size: 0.8rem;
            cursor: pointer;
            text-decoration: underline;
        }
        
        /* --- FILTRY --- */
        #filterContainer {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed var(--color-neon-blue);
        }
        
        .filter-tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        
        .filter-checkbox {
            display: none;
        }
        
        .filter-label {
            padding: 5px 10px;
            border: 1px solid var(--color-accent-pink);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8rem;
            color: var(--color-accent-pink);
            font-family: 'Roboto Mono', monospace;
        }
        
        .filter-checkbox:checked + .filter-label {
            background-color: var(--color-neon-blue);
            border-color: var(--color-neon-blue);
            color: var(--color-dark);
            box-shadow: 0 0 8px var(--color-neon-blue);
        }
        
        /* --- Sekcja Edycji/Usuwania --- */
        .popup-actions button {
            background-color: var(--color-accent-pink);
            color: var(--color-white);
            margin-top: 10px;
            font-size: 0.8rem;
            padding: 5px 10px;
        }

        .popup-actions button:hover {
            background-color: var(--color-dark-blue);
            box-shadow: 0 0 8px var(--color-accent-pink);
        }
        
        /* --- Responsywność dla Sidebar'a --- */
        #menuToggle {
            display: none;
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 30;
            background: var(--color-accent-pink);
            color: var(--color-dark);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5rem;
            justify-content: center;
            align-items: center;
        }
        
        @media (max-width: 768px) {
            #menuToggle {
                display: flex;
            }
        }
        
    </style>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
</head>
<body>

    <div id="loader">
        <h1>SKEJTY</h1>
    </div>

    <div id="cursor"></div>

    <div id="notificationContainer"></div>

    <button id="menuToggle" data-hover><i class="fas fa-bars"></i></button>

    <div class="app-container">
        
        <div id="map"></div>

        <div id="sidebar">
            <div id="navHeader">
                <h1>SKEJTY</h1>
                <div class="nav-buttons">
                    <button id="addSpotBtn" data-hover>DODAJ</button>
                    <button id="navKonto" data-hover>KONTO</button>
                    <button id="navLogout" data-hover style="display: none;">WYLOGUJ</button>
                </div>
            </div>
            
            <div id="authSection" class="form-group">
                <div id="loggedUser" style="display: none;">
                    <p style="color: #00FF00; font-family: 'Roboto Mono', monospace;">Zalogowano jako: <span id="currentUserName"></span></p>
                    <button id="logoutBtn" data-hover style="background-color: var(--color-accent-pink); margin-top: 10px;">WYLOGUJ</button>
                </div>
                
                <div id="loginForm">
                    <label for="loginEmail">Email:</label>
                    <input type="text" id="loginEmail" placeholder="user@domain.com">
                    
                    <label for="loginPassword">Hasło:</label>
                    <input type="password" id="loginPassword" placeholder="******">
                    
                    <button id="loginBtn" data-hover style="margin-top: 10px;">ZALOGUJ</button>
                    <a class="auth-toggle" onclick="toggleAuth('register')">Nie masz konta? Zarejestruj się.</a>
                </div>
                
                <div id="registerForm" style="display: none;">
                    <label for="registerEmail">Email:</label>
                    <input type="text" id="registerEmail" placeholder="user@domain.com">
                    
                    <label for="registerPassword">Hasło:</label>
                    <input type="password" id="registerPassword" placeholder="******">
                    
                    <button id="registerBtn" data-hover style="margin-top: 10px;">ZAREJESTRUJ</button>
                    <a class="auth-toggle" onclick="toggleAuth('login')">Masz już konto? Zaloguj się.</a>
                </div>
            </div>
            
            <form id="spotForm">
                <input type="hidden" id="editingSpotId">
                <div class="form-group">
                    <label for="spotNameEl">Nazwa Spotu:</label>
                    <input type="text" id="spotNameEl" required>
                </div>
                
                <div class="form-group">
                    <label for="spotDescEl">Opis:</label>
                    <textarea id="spotDescEl" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Lokalizacja (kliknij na mapę):</label>
                    <input type="text" id="spotLatEl" placeholder="Szerokość geograficzna" readonly required>
                    <input type="text" id="spotLngEl" placeholder="Długość geograficzna" readonly required style="margin-top: 5px;">
                </div>
                
                <div class="form-group">
                    <label for="spotBustEl">Poziom Bustu (0-5):</label>
                    <input type="range" id="spotBustEl" min="0" max="5" value="0" oninput="document.getElementById('bustValue').innerText=this.value">
                    <span id="bustValue" style="color: var(--color-accent-pink); font-family: 'Roboto Mono', monospace;">0</span>
                </div>

                <div class="form-group">
                    <label>Zdjęcie Spotu (max 10MB):</label>
                    <input type="file" id="spotImageUploadEl" accept="image/*">
                </div>
                
                <div class="form-group">
                    <label>Tagi:</label>
                    <div class="tags-container" id="spotTagsContainer">
                        </div>
                </div>
                
                <div class="form-group" id="stairsCountGroup" style="display:none;">
                    <label for="stairsRange">Ilość Schodów:</label>
                    <input type="range" id="stairsRange" min="1" max="20" value="1" oninput="document.getElementById('stairsValue').innerText=this.value">
                    <span id="stairsValue" style="color: var(--color-accent-pink); font-family: 'Roboto Mono', monospace;">1</span>
                </div>

                <div class="form-group" id="otherInputGroup" style="display:none;">
                    <label for="otherInputValue">Opis Innego Elementu:</label>
                    <input type="text" id="otherInputValue">
                </div>

                <div class="form-group">
                    <input type="checkbox" id="spotLightsEl" style="width: auto;">
                    <label for="spotLightsEl" style="display: inline; margin-left: 5px;">Oświetlony (Można jeździć w nocy)</label>
                </div>

                <button id="saveSpotBtn" type="button" data-hover>ZAPISZ NA MAPIE</button>
            </form>
            
            <div id="filterContainer">
                <label style="color: var(--color-accent-pink); font-size: 1rem;">FILTRY:</label>
                <div class="filter-tags-container" id="filterTagsContainer">
                    </div>
            </div>

            <div style="flex-grow: 1;"></div>
            <p style="font-size: 0.7rem; color: var(--color-neon-blue); text-align: center; margin-top: 20px; font-family: 'Roboto Mono', monospace;">
                &copy; 2023 SKEJTY. Dane: Firebase Firestore, Hosting zdjęć: Uploadcare.
            </p>
        </div>

    </div>

    <script>
        // Inicjalizacja Firebase (WPISZ SWOJE DANE KONFIGURACYJNE TUTAJ)
        const firebaseConfig = {
            // apiKey: "",
            // authDomain: "",
            // projectId: "",
            // storageBucket: "",
            // messagingSenderId: "",
            // appId: ""
        };

        if (firebaseConfig.projectId) {
            firebase.initializeApp(firebaseConfig);
            var db = firebase.firestore();
            var auth = firebase.auth();
            var spotsCollection = db.collection("spots");
        } else {
            // Wersja demo / mock, jeśli klucze nie są podane
            console.error("Firebase nie skonfigurowane. Używam trybu demo.");
            var auth = { onAuthStateChanged: (callback) => callback(null) };
            var spotsCollection = { onSnapshot: (callback) => callback({ docs: [] }), add: () => Promise.reject("Demo Mode"), doc: () => ({ update: () => Promise.reject("Demo Mode"), delete: () => Promise.reject("Demo Mode") }) };
        }

        let map, currentMarker, currentUser = null;
        let spots = [];
        let editingSpotId = null;

        // --- ELEMENTY DOM ---
        const sidebar = document.getElementById('sidebar');
        const spotForm = document.getElementById('spotForm');
        const addSpotBtn = document.getElementById('addSpotBtn');
        const saveSpotBtn = document.getElementById('saveSpotBtn');
        const navKonto = document.getElementById('navKonto');
        const navLogout = document.getElementById('navLogout');
        const authSection = document.getElementById('authSection');
        const loginFormEl = document.getElementById('loginForm');
        const registerFormEl = document.getElementById('registerForm');
        const loggedUserEl = document.getElementById('loggedUser');
        const menuToggle = document.getElementById('menuToggle');
        
        // Elementy formularza
        const spotNameEl = document.getElementById('spotNameEl');
        const spotDescEl = document.getElementById('spotDescEl');
        const spotLatEl = document.getElementById('spotLatEl');
        const spotLngEl = document.getElementById('spotLngEl');
        const spotBustEl = document.getElementById('spotBustEl');
        const spotImageUploadEl = document.getElementById('spotImageUploadEl');
        const spotTagsContainer = document.getElementById('spotTagsContainer');
        const stairsCountGroup = document.getElementById('stairsCountGroup');
        const stairsRange = document.getElementById('stairsRange');
        const otherInputGroup = document.getElementById('otherInputGroup');
        const otherInputValue = document.getElementById('otherInputValue');
        const spotLightsEl = document.getElementById('spotLightsEl');
        
        // --- TAGI I FILTRY ---
        const availableTags = ['Schody', 'Poręcz', 'Ławka', 'Krzywa', 'Flatground', 'Manual', 'Woda', 'Cegła', 'Inne'];

        function createTagCheckboxes(container, type, onChangeCallback = null) {
            container.innerHTML = '';
            availableTags.forEach(tag => {
                const id = `${type}${tag}`;
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = id;
                input.value = tag;
                input.className = `${type}-checkbox`;
                if (onChangeCallback) {
                    input.addEventListener('change', onChangeCallback);
                }

                const label = document.createElement('label');
                label.htmlFor = id;
                label.innerText = tag;
                label.className = `${type}-label`;
                label.setAttribute('data-hover', true);
                
                container.appendChild(input);
                container.appendChild(label);
            });
        }
        
        // Utwórz tagi dla formularza
        createTagCheckboxes(spotTagsContainer, 'tag', handleTagChange);
        const spotTags = document.querySelectorAll('.tag-checkbox');

        // Utwórz tagi dla filtrów
        const filterTagsContainer = document.getElementById('filterTagsContainer');
        createTagCheckboxes(filterTagsContainer, 'filter', () => renderSpots(getActiveFilters()));
        const filterTags = document.querySelectorAll('.filter-checkbox');

        function handleTagChange(event) {
            const isStairs = event.target.value === 'Schody';
            const isOther = event.target.value === 'Inne';
            
            if (isStairs) {
                stairsCountGroup.style.display = event.target.checked ? 'block' : 'none';
            }
            if (isOther) {
                otherInputGroup.style.display = event.target.checked ? 'block' : 'none';
            }
        }
        
        // --- NOTYFIKACJE ---
        function showNotification(message, type = 'info', duration = 4000) {
            const container = document.getElementById('notificationContainer');
            const note = document.createElement('div');
            note.className = `notification ${type}`;
            note.innerText = message;
            
            container.appendChild(note);
            
            setTimeout(() => {
                note.classList.add('show');
            }, 10);

            setTimeout(() => {
                note.classList.remove('show');
                note.addEventListener('transitionend', () => note.remove());
            }, duration);
        }

        // --- MAPA ---
        function initMap() {
            map = L.map('map', {
                maxZoom: 18,
                minZoom: 2,
                zoomControl: false 
            }).setView([52.0, 19.0], 6); // Polska centralnie
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
            }).addTo(map);

            L.control.zoom({
                 position: 'bottomright' 
            }).addTo(map);

            map.on('click', onMapClick);
        }
        
        function onMapClick(e) {
            if (spotForm.style.display === 'block' && editingSpotId === null) {
                // Jeśli formularz dodawania jest otwarty
                if (currentMarker) {
                    map.removeLayer(currentMarker);
                }
                
                // Utwórz tymczasowy marker w miejscu kliknięcia
                currentMarker = L.marker(e.latlng, {
                    icon: L.divIcon({ className: 'spot-marker' })
                }).addTo(map);

                // Wypełnij pola formularza
                spotLatEl.value = e.latlng.lat.toFixed(6);
                spotLngEl.value = e.latlng.lng.toFixed(6);
            }
        }
        
        function getActiveFilters() {
            const activeTags = Array.from(filterTags)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            return { tags: activeTags };
        }

        function renderSpots(filters) {
            // Usuń wszystkie istniejące markery (oprócz tymczasowego, jeśli jest)
            map.eachLayer(layer => {
                if (layer instanceof L.Marker && layer !== currentMarker) {
                    map.removeLayer(layer);
                }
            });

            spots.forEach(spot => {
                // Filtracja
                if (filters.tags.length > 0) {
                    const matches = filters.tags.every(filterTag => spot.tags.includes(filterTag));
                    if (!matches) {
                        return; // Pomiń, jeśli spot nie pasuje do wszystkich wybranych tagów
                    }
                }
                
                // Tworzenie markera
                const marker = L.marker([spot.lat, spot.lng], {
                    icon: L.divIcon({ className: 'spot-marker' })
                }).addTo(map);
                
                // Zawartość popupu
                marker.bindPopup(createPopupContent(spot)).openPopup();
            });
        }
        
        function createPopupContent(spot) {
            const tagsHtml = spot.tags.map(tag => `<span>${tag}</span>`).join('');
            const stairsCountHtml = spot.stairsCount ? `<p><strong>Ilość schodów:</strong> ${spot.stairsCount}</p>` : '';
            const lightsHtml = spot.lights ? `<p style="color: #00FF00;">Oświetlenie: Tak (Nocna Jazda)</p>` : '<p style="color: var(--color-accent-pink);">Oświetlenie: Brak</p>';
            const otherDescHtml = spot.otherDescription ? `<p><strong>Inne:</strong> ${spot.otherDescription}</p>` : '';
            const imageHtml = spot.imageData ? `<img src="${spot.imageData}" class="popup-image" alt="Zdjęcie spotu">` : '<p style="font-style: italic;">Brak zdjęcia</p>';
            
            let actionsHtml = '';
            if (currentUser && currentUser.uid === spot.authorId) {
                actionsHtml = `
                    <div class="popup-actions">
                        <button onclick="editSpot('${spot.id}')" data-hover>EDYTUJ</button>
                        <button onclick="deleteSpot('${spot.id}')" style="background-color: #FF4500;" data-hover>USUŃ</button>
                    </div>
                `;
            }

            return `
                <div style="font-family: 'Roboto Mono', monospace;">
                    <h3 class="popup-header">${spot.name}</h3>
                    <p>${spot.description || 'Brak opisu.'}</p>
                    ${imageHtml}
                    <p class="popup-tags">${tagsHtml}</p>
                    <p><strong>Bust:</strong> ${spot.bust}/5</p>
                    ${stairsCountHtml}
                    ${otherDescHtml}
                    ${lightsHtml}
                    <p class="popup-author">Dodano przez: ${spot.authorName || 'Anonim'} | ${spot.timestamp ? new Date(spot.timestamp.toDate()).toLocaleDateString() : 'N/A'}</p>
                    ${actionsHtml}
                </div>
            `;
        }

        // --- AUTORYZACJA ---
        function toggleAuth(formType) {
            if (formType === 'login') {
                loginFormEl.style.display = 'block';
                registerFormEl.style.display = 'none';
            } else {
                loginFormEl.style.display = 'none';
                registerFormEl.style.display = 'block';
            }
        }

        document.getElementById('navKonto').addEventListener('click', () => {
             authSection.style.display = (authSection.style.display === 'block') ? 'none' : 'block';
             spotForm.style.display = 'none';
        });

        document.getElementById('registerBtn').addEventListener('click', async () => {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            try {
                await auth.createUserWithEmailAndPassword(email, password);
                showNotification("Pomyślna rejestracja i logowanie!", 'success');
            } catch (error) {
                showNotification("Błąd rejestracji: " + error.message, 'error', 6000);
            }
        });

        document.getElementById('loginBtn').addEventListener('click', async () => {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                await auth.signInWithEmailAndPassword(email, password);
                showNotification("Pomyślne logowanie!", 'success');
            } catch (error) {
                showNotification("Błąd logowania: " + error.message, 'error', 6000);
            }
        });

        const logoutHandler = async () => {
            try {
                await auth.signOut();
                showNotification("Wylogowano pomyślnie.", 'info');
            } catch (error) {
                showNotification("Błąd wylogowania: " + error.message, 'error', 6000);
            }
        };

        document.getElementById('logoutBtn').addEventListener('click', logoutHandler);
        navLogout.addEventListener('click', logoutHandler);

        // --- FORMULARZ ---
        function resetForm(keepLocation = false) {
            editingSpotId = null;
            spotNameEl.value = '';
            spotDescEl.value = '';
            spotBustEl.value = '0';
            document.getElementById('bustValue').innerText = '0';
            spotImageUploadEl.value = '';
            spotLightsEl.checked = false;
            
            // Odznaczenie tagów
            spotTags.forEach(cb => { cb.checked = false; });
            stairsCountGroup.style.display = 'none';
            otherInputGroup.style.display = 'none';
            
            if (!keepLocation) {
                spotLatEl.value = '';
                spotLngEl.value = '';
                if (currentMarker) {
                    map.removeLayer(currentMarker);
                    currentMarker = null;
                }
            }
            saveSpotBtn.innerText = 'ZAPISZ NA MAPIE';
        }
        
        function toggleForm(forceOpen = false) {
            if (forceOpen) {
                spotForm.style.display = 'block';
                authSection.style.display = 'none';
            } else {
                // Jeśli jest otwarty, zamknij, w przeciwnym razie pozostaw zamknięty
                if (spotForm.style.display === 'block') {
                    spotForm.style.display = 'none';
                    resetForm();
                }
            }
        }
        
        addSpotBtn.addEventListener('click', () => {
            if (!currentUser) {
                 showNotification("Musisz być zalogowany, aby dodać spot!", 'error');
                 return;
            }
            toggleForm(true);
            resetForm();
        });

        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
        });
        
        // --- FUNKCJE EDYCJI / USUWANIA Z GLOBALNEGO ZASIĘGU ---
        window.editSpot = (id) => {
            const spot = spots.find(s => s.id === id);
            if (!spot) return;

            // Zamykanie popupu
            map.closePopup();

            // Upewnienie się, że formularz jest otwarty i czysty
            toggleForm(true);
            resetForm(true); // Resetuj, ale zachowaj obecną lokalizację (której i tak nie dotykamy)
            
            // Ustaw flagę edycji
            editingSpotId = id;
            saveSpotBtn.innerText = 'ZAPISZ ZMIANY';
            
            // Wypełnianie formularza danymi spotu
            spotNameEl.value = spot.name;
            spotDescEl.value = spot.description;
            spotLatEl.value = spot.lat.toFixed(6);
            spotLngEl.value = spot.lng.toFixed(6);
            spotBustEl.value = spot.bust;
            document.getElementById('bustValue').innerText = spot.bust;
            spotLightsEl.checked = spot.lights;
            
            // Tagi
            spotTags.forEach(cb => {
                cb.checked = spot.tags.includes(cb.value);
            });

            // Schody
            if (spot.tags.includes('Schody')) {
                stairsCountGroup.style.display = 'block';
                stairsRange.value = spot.stairsCount || 1;
                document.getElementById('stairsValue').innerText = spot.stairsCount || 1;
            } else {
                stairsCountGroup.style.display = 'none';
            }

            // Inne
            if (spot.tags.includes('Inne')) {
                otherInputGroup.style.display = 'block';
                otherInputValue.value = spot.otherDescription || '';
            } else {
                otherInputGroup.style.display = 'none';
            }

            // Ustawienie markera w miejscu edytowanego spotu
            if (currentMarker) map.removeLayer(currentMarker);
            currentMarker = L.marker([spot.lat, spot.lng], {
                icon: L.divIcon({ className: 'spot-marker' })
            }).addTo(map);

            showNotification(`Edytujesz spot: ${spot.name}`, 'info', 3000);
        };

        window.deleteSpot = async (id) => {
            if (!confirm("Czy na pewno chcesz usunąć ten spot? Tego nie można cofnąć!")) return;
            
            map.closePopup();

            try {
                await spotsCollection.doc(id).delete();
                showNotification("Spot usunięty pomyślnie!", 'success');
            } catch (error) {
                showNotification("Błąd usuwania spota: " + error.message, 'error', 6000);
            }
        };

// --- FUNKCJA ZAPISYWANIA SPOTA (Z UPLOADCARE STORAGE) ---

// TWÓJ KLUCZ PUBLICZNY Z UPLOADCARE
const UPLOADCARE_PUBLIC_KEY = "d850143b4baca5f2b800"; 

        saveSpotBtn.addEventListener('click', async () => {
            if (!currentUser) {
                showNotification("Musisz być zalogowany!", 'error');
                return;
            }
            if (!spotNameEl.value || !spotLatEl.value) {
                showNotification("Wypełnij nazwę i wybierz miejsce na mapie.", 'error');
                return;
            }
            
            let finalImageUrl = ''; 
            const imageFile = spotImageUploadEl.files[0];
            
            // 1. Zaczynamy od wysyłania zdjęcia do Uploadcare, jeśli istnieje
            if (imageFile) {
                // Maksymalny limit rozmiaru (10MB dla bezpieczeństwa)
                if (imageFile.size > 10 * 1024 * 1024) { 
                     showNotification("Plik jest za duży! Maksymalny rozmiar to 10MB.", 'error');
                     return;
                }
                
                // Zmieniamy tekst przycisku
                saveSpotBtn.innerText = editingSpotId ? "WYSYŁANIE ZDJĘCIA..." : "WYSYŁANIE ZDJĘCIA...";
                
                try {
                    // Tworzenie obiektu FormData
                    const formData = new FormData();
                    // Dodanie klucza publicznego (wymagane przez Uploadcare)
                    formData.append("UPLOADCARE_PUBLIC_KEY", UPLOADCARE_PUBLIC_KEY); 
                    // Dodanie pliku
                    formData.append("file", imageFile); 
                    
                    // Wysyłanie do API Uploadcare
                    const response = await fetch("https://upload.uploadcare.com/base/", {
                        method: 'POST',
                        body: formData // Wysyłanie danych formularza
                    });

                    const data = await response.json();

                    if (data.error || !data.file) {
                        throw new Error(data.error || 'Błąd Uploadcare');
                    }

                    // Otrzymanie linku do zdjęcia (Uploadcare generuje linki na podstawie UID pliku)
                    finalImageUrl = `https://ucarecdn.com/${data.file}/${imageFile.name}`; 
                    showNotification("Zdjęcie wysłane pomyślnie!", 'info', 2000);

                } catch (error) {
                    showNotification("Błąd wysyłania zdjęcia do Uploadcare: " + error.message, 'error', 6000);
                    // Jeśli błąd wysyłania, przerywamy cały proces
                    saveSpotBtn.innerText = editingSpotId ? "ZAPISZ ZMIANY" : "ZAPISZ NA MAPIE";
                    return; 
                }
            }
            
            // 2. Przywracamy tekst i zapisujemy do Firestore
            saveSpotBtn.innerText = editingSpotId ? "ZAPISYWANIE DANYCH..." : "DODAWANIE SPOTA...";

            try {
                const selectedTags = Array.from(spotTags)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);

                // Pobieranie danych dodatkowych
                const stairsCount = selectedTags.includes('Schody') ? parseInt(stairsRange.value) : null;
                const otherDescription = selectedTags.includes('Inne') ? otherInputValue.value : null;

                // Tworzenie obiektu spotData
                const spotData = {
                    name: spotNameEl.value,
                    description: spotDescEl.value,
                    lat: parseFloat(spotLatEl.value),
                    lng: parseFloat(spotLngEl.value),
                    bust: spotBustEl.value,
                    tags: selectedTags,
                    lights: spotLightsEl.checked,
                    authorId: currentUser.uid,
                    authorName: currentUser.displayName || currentUser.email.split('@')[0],
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    stairsCount: stairsCount,
                    otherDescription: otherDescription
                };

                // 3. Obsługa pola imageData (teraz to URL z Uploadcare CDN)
                if (finalImageUrl) {
                    spotData.imageData = finalImageUrl;
                } else if (editingSpotId) {
                    // Jeśli edytujemy, ale nie wybrano nowego zdjęcia, zachowaj stare lub usuń pole
                    const oldSpot = spots.find(s => s.id === editingSpotId);
                    if (oldSpot && oldSpot.imageData) {
                        spotData.imageData = oldSpot.imageData;
                    } else {
                        spotData.imageData = firebase.firestore.FieldValue.delete();
                    }
                }

                // 4. Zapis do Firestore
                if (editingSpotId) {
                    await spotsCollection.doc(editingSpotId).update(spotData);
                    showNotification(`Spot "${spotData.name}" zaktualizowany!`, 'success');
                } else {
                    await spotsCollection.add(spotData);
                    showNotification(`Nowy spot "${spotData.name}" dodany!`, 'success');
                }

                toggleForm(false);

            } catch (error) {
                showNotification("Błąd zapisu danych w bazie: " + error.message, 'error', 6000);
                console.error("Błąd zapisu:", error);
            } finally {
                saveSpotBtn.innerText = editingSpotId ? "ZAPISZ ZMIANY" : "ZAPISZ NA MAPIE";
            }
        });
        
        // --- OBSŁUGA AUTH ZMIANY STANU ---
        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                // Zalogowany
                loggedUserEl.style.display = 'block';
                document.getElementById('currentUserName').innerText = user.displayName || user.email;
                navKonto.style.display = 'none';
                navLogout.style.display = 'block';
                loginFormEl.style.display = 'none';
                registerFormEl.style.display = 'none';
            } else {
                // Wylogowany
                loggedUserEl.style.display = 'none';
                navLogout.style.display = 'none'; 
                navKonto.style.display = 'flex'; 
                toggleForm(false);
            }
            authSection.style.display = 'none';
            renderSpots(getActiveFilters());
        });

        // --- START APLIKACJI ---
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            gsap.to('#loader', { opacity: 0, duration: 0.8, delay: 1, onComplete: () => {
                document.getElementById('loader').style.display = 'none';
                gsap.to('.app-container', { opacity: 1, duration: 0.5 });
            }});
            
            spotsCollection.onSnapshot(snapshot => {
                spots = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSpots(getActiveFilters()); 
            });
        });

        // --- CUSTOM CURSOR ---
        const customCursor = document.getElementById('cursor');
        document.addEventListener('mousemove', (e) => {
            customCursor.style.left = e.clientX + 'px';
            customCursor.style.top = e.clientY + 'px';
        });

        document.querySelectorAll('[data-hover]').forEach(el => {
            el.addEventListener('mouseover', () => customCursor.classList.add('hovered'));
            el.addEventListener('mouseout', () => customCursor.classList.remove('hovered'));
        });
        
        // --- FUNKCJA FULLSCREEN ---
        function requestFullscreen() {
            const element = document.documentElement;
            if (element.requestFullscreen) {
                element.requestFullscreen();
            } else if (element.mozRequestFullScreen) { // Firefox
                element.mozRequestFullScreen();
            } else if (element.webkitRequestFullscreen) { // Chrome, Safari and Opera
                element.webkitRequestFullscreen();
            } else if (element.msRequestFullscreen) { // IE/Edge
                element.msRequestFullscreen();
            }
        }
        
    </script>
</body>
</html>
