<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKEJTY - Multi Upload</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto+Mono:wght@300;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"> 
    
    <style>
        /* ... (wszystkie poprzednie style) ... */
        :root {
            --neon-green: #39ff14; --neon-pink: #ff00ff; --neon-blue: #00f3ff;
            --neon-red: #ff3131; --neon-orange: #ffaa00; --main-bg: #f0f0f0; 
            --sidebar-bg: rgba(240, 240, 240, 0.95); --text-color: #111;
            --card-bg: white; --form-bg: white; --comment-bg: #f4f4f4; --shadow-color: rgba(0,0,0,0.1);
        }
        body.dark-mode {
            --main-bg: #1a1a2e; --sidebar-bg: rgba(26, 26, 46, 0.98);
            --text-color: #f0f0f0; --card-bg: #2d2d4d; --form-bg: #3e3e6e;
            --comment-bg: #4a4a7d; --shadow-color: rgba(0, 243, 255, 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; cursor: none; }
        body { font-family: 'Orbitron', sans-serif; background-color: var(--main-bg); color: var(--text-color); height: 100vh; transition: background-color 0.5s; }
        #cursor { position: fixed; width: 20px; height: 20px; border: 2px solid var(--neon-pink); border-radius: 50%; pointer-events: none; z-index: 9999; transform: translate(-50%, -50%); transition: width 0.2s, height 0.2s; mix-blend-mode: difference; }
        #cursor.hovered { width: 50px; height: 50px; background: rgba(255, 0, 255, 0.2); mix-blend-mode: normal; }
        .app-container { display: grid; grid-template-columns: 400px 1fr; height: 100vh; opacity: 0; }
        .sidebar { background: var(--sidebar-bg); border-right: 2px solid var(--neon-pink); padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        #map-container { position: relative; width: 100%; height: 100%; }
        #map { width: 100%; height: 100%; }
        .btn-neon { font-family: 'Orbitron'; font-weight: bold; padding: 10px; margin: 5px 0; border: 2px solid; border-radius: 5px; cursor: pointer; background: transparent; width: 100%; transition: 0.3s; color: var(--neon-blue); border-color: var(--neon-blue); }
        .btn-neon:hover { background: var(--neon-blue); color: #000; box-shadow: 0 0 15px var(--neon-blue); }
        
        /* NOWE STYLE DLA GALERII */
        .preview-gallery {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }
        .preview-slot {
            aspect-ratio: 1/1;
            border: 1px dashed var(--neon-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: rgba(0,0,0,0.2);
            position: relative;
        }
        .preview-slot img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .spot-images-container {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
            margin-bottom: 10px;
            scrollbar-width: thin;
            scrollbar-color: var(--neon-pink) transparent;
        }
        .spot-card-img {
            height: 150px;
            flex: 0 0 auto;
            border-radius: 5px;
            border: 1px solid var(--neon-pink);
            cursor: pointer;
        }
        .remove-img-btn {
            position: absolute; top: 0; right: 0; background: var(--neon-red); color: white; border: none; font-size: 10px; padding: 2px 5px; cursor: pointer;
        }

        @media (max-width: 768px) {
            .app-container { grid-template-columns: 1fr; }
            .sidebar { position: fixed; bottom: 60px; width: 100%; height: 50vh; transform: translateY(100%); z-index: 1000; }
            .sidebar.active { transform: translateY(0); }
        }
    </style>
</head>
<body class="dark-mode">
    <div id="cursor"></div>
    <div id="loader" style="position:fixed; inset:0; background:var(--main-bg); z-index:10000; display:flex; align-items:center; justify-content:center; flex-direction:column;">
        <div class="skate-wheel" style="width:50px; height:50px; border:5px solid var(--neon-green); border-top-color:var(--neon-pink); border-radius:50%; animation:spin 1s linear infinite;"></div>
        <h2 style="font-family:Orbitron; margin-top:10px;">Ładowanie...</h2>
    </div>

    <div class="app-container">
        <div class="sidebar" id="mainSidebar">
            <h1>SKEJ<span style="color:var(--neon-pink)">TY</span></h1>
            <div id="authContent" class="sidebar-section active">
                <div id="authStatus">Ładowanie...</div>
                <button class="btn-neon" id="showLoginBtn">ZALOGUJ</button>
                <div id="loginForm" style="display:none; margin-top:10px;">
                    <input type="email" id="loginEmail" placeholder="Email" style="width:100%; padding:8px; margin-bottom:5px;">
                    <input type="password" id="loginPassword" placeholder="Hasło" style="width:100%; padding:8px; margin-bottom:5px;">
                    <button class="btn-neon" onclick="handleLogin()">WEJDŹ</button>
                </div>
                <button class="btn-neon" id="logoutBtn" style="display:none;">WYLOGUJ</button>
            </div>
            <div id="spotsListContent" class="sidebar-section" style="margin-top:20px;">
                <div id="spotsList"></div>
            </div>
        </div>

        <div id="map-container">
            <div id="map"></div>
            <div id="addSpotFab" style="position:fixed; bottom:80px; right:20px; width:60px; height:60px; background:var(--neon-pink); border-radius:50%; display:none; align-items:center; justify-content:center; font-size:30px; cursor:pointer; z-index:2000;">+</div>
            
            <div id="spot-form" style="display:none; position:fixed; bottom:20px; right:20px; background:var(--card-bg); padding:20px; border:2px solid var(--neon-pink); width:350px; z-index:3000; max-height: 80vh; overflow-y: auto;">
                <h3 id="formTitle">DODAJ SPOT</h3>
                <input type="text" id="spotName" placeholder="Nazwa spota" style="width:100%; padding:8px; margin:10px 0;">
                <textarea id="spotDesc" placeholder="Opis..." style="width:100%; padding:8px; margin-bottom:10px;"></textarea>
                
                <label style="font-size: 0.8rem;">Zdjęcia (Max 3, każde do 250KB - auto-kompresja):</label>
                <input type="file" id="spotImageUpload" accept="image/*" multiple style="margin:10px 0; width: 100%;">
                
                <div class="preview-gallery" id="previewGallery">
                    </div>

                <input type="hidden" id="spotLat"><input type="hidden" id="spotLng">
                <button class="btn-neon" id="saveSpotBtn">ZAPISZ NA MAPIE</button>
                <button class="btn-neon" onclick="toggleForm(false)" style="border-color:var(--neon-red); color:var(--neon-red)">ANULUJ</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // === KONFIGURACJA FIREBASE (Użyj swojej) ===
        const firebaseConfig = {
            apiKey: "AIzaSyCCxW6X7MJlWPfxP_6I8FlLc7Vp2wiR69Q",
            authDomain: "skejspoty.firebaseapp.com",
            projectId: "skejspoty",
            storageBucket: "skejspoty.firebasestorage.app",
            messagingSenderId: "1067851773136",
            appId: "1:1067851773136:web:39bdc7f7af34cbbf94dad5"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // STAN APLIKACJI
        let currentUser = null;
        let uploadedImages = []; // Tablica przechowująca Base64
        const MAX_IMAGES = 3;

        // MAPA
        const map = L.map('map').setView([52.2297, 21.0122], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // --- KONWERTER I KOMPRESOR OBRAZU ---
        async function processImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // Skalowanie, jeśli obraz jest za duży (max 1200px szerokości)
                        const MAX_WIDTH = 1200;
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // Kompresja do JPEG (0.7 quality zazwyczaj daje ~100-200kb)
                        const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                        resolve(compressedBase64);
                    };
                };
            });
        }

        // --- OBSŁUGA PLIKÓW ---
        const fileInput = document.getElementById('spotImageUpload');
        const previewGallery = document.getElementById('previewGallery');

        fileInput.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            
            for (const file of files) {
                if (uploadedImages.length >= MAX_IMAGES) break;
                
                const compressed = await processImage(file);
                uploadedImages.push(compressed);
            }
            renderPreview();
            fileInput.value = ""; // reset inputa
        });

        function renderPreview() {
            previewGallery.innerHTML = "";
            uploadedImages.forEach((base64, index) => {
                const div = document.createElement('div');
                div.className = "preview-slot";
                div.innerHTML = `
                    <img src="${base64}">
                    <button class="remove-img-btn" onclick="removeImage(${index})">&times;</button>
                `;
                previewGallery.appendChild(div);
            });
        }

        window.removeImage = (index) => {
            uploadedImages.splice(index, 1);
            renderPreview();
        };

        // --- ZAPISYWANIE ---
        document.getElementById('saveSpotBtn').addEventListener('click', async () => {
            const name = document.getElementById('spotName').value;
            const lat = document.getElementById('spotLat').value;
            const lng = document.getElementById('spotLng').value;

            if (!name || !lat) return alert("Podaj nazwę i kliknij na mapę!");

            const spotData = {
                name,
                description: document.getElementById('spotDesc').value,
                lat: parseFloat(lat),
                lng: parseFloat(lng),
                images: uploadedImages, // Zapisujemy tablicę Base64
                authorId: currentUser.uid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            await db.collection('spots').add(spotData);
            toggleForm(false);
            alert("Spot dodany!");
        });

        // --- RENDEROWANIE KARTY (Z wieloma zdjęciami) ---
        function createSpotCard(spot) {
            const div = document.createElement('div');
            div.className = "spot-card";
            div.style = "background:var(--card-bg); border:1px solid var(--neon-pink); padding:15px; margin-bottom:15px; border-radius:10px;";
            
            let imagesHtml = "";
            if (spot.images && spot.images.length > 0) {
                imagesHtml = `<div class="spot-images-container">`;
                spot.images.forEach(imgData => {
                    imagesHtml += `<img src="${imgData}" class="spot-card-img" onclick="window.open('${imgData}')">`;
                });
                imagesHtml += `</div>`;
            }

            div.innerHTML = `
                <h3 style="color:var(--neon-blue)">${spot.name}</h3>
                ${imagesHtml}
                <p>${spot.description || ''}</p>
                <button class="btn-neon" style="font-size:10px" onclick="map.flyTo([${spot.lat}, ${spot.lng}], 17)">POKAŻ NA MAPIE</button>
            `;
            return div;
        }

        // --- LOGIKA UI ---
        function toggleForm(show, lat, lng) {
            const form = document.getElementById('spot-form');
            form.style.display = show ? 'block' : 'none';
            if (show) {
                document.getElementById('spotLat').value = lat;
                document.getElementById('spotLng').value = lng;
                uploadedImages = [];
                renderPreview();
            }
        }

        map.on('click', (e) => {
            if (currentUser) toggleForm(true, e.latlng.lat, e.latlng.lng);
        });

        document.getElementById('addSpotFab').onclick = () => alert("Kliknij teraz w dowolne miejsce na mapie!");

        // --- FIREBASE AUTH ---
        auth.onAuthStateChanged(user => {
            currentUser = user;
            document.getElementById('loader').style.display = 'none';
            document.querySelector('.app-container').style.opacity = '1';
            
            if (user) {
                document.getElementById('authStatus').innerText = `Siema, ${user.email}`;
                document.getElementById('addSpotFab').style.display = 'flex';
                document.getElementById('logoutBtn').style.display = 'block';
                document.getElementById('showLoginBtn').style.display = 'none';
            } else {
                document.getElementById('authStatus').innerText = "Zaloguj się, aby dodawać";
                document.getElementById('addSpotFab').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'none';
                document.getElementById('showLoginBtn').style.display = 'block';
            }
        });

        // ŁADOWANIE SPOTÓW
        db.collection('spots').orderBy('timestamp', 'desc').onSnapshot(snap => {
            const list = document.getElementById('spotsList');
            list.innerHTML = "";
            snap.forEach(doc => {
                const spot = doc.data();
                list.appendChild(createSpotCard(spot));
                L.marker([spot.lat, spot.lng]).addTo(map).bindPopup(spot.name);
            });
        });

        // Pozostałe funkcje logowania (uproszczone dla przykładu)
        document.getElementById('showLoginBtn').onclick = () => document.getElementById('loginForm').style.display = 'block';
        window.handleLogin = () => {
            const e = document.getElementById('loginEmail').value;
            const p = document.getElementById('loginPassword').value;
            auth.signInWithEmailAndPassword(e, p).catch(err => alert(err.message));
        };
        document.getElementById('logoutBtn').onclick = () => auth.signOut();

        // Custom Cursor
        const cursor = document.getElementById('cursor');
        document.addEventListener('mousemove', e => {
            cursor.style.left = e.clientX + 'px';
            cursor.style.top = e.clientY + 'px';
        });
    </script>
</body>
</html>
