<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKEJTSPOTY</title>
    
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="icon" type="image/x-icon" href="/favicon.ico"> 
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    ```

### 2. Uko≈Ñczenie i Udoskonalenie Skryptu JavaScript

Tw√≥j kod JavaScript urywa siƒô. Poni≈ºej znajduje siƒô pe≈Çny i udoskonalony kod, kt√≥ry obejmuje logikƒô uwierzytelniania, prze≈ÇƒÖczania formularzy i obs≈Çugi filtr√≥w. Doda≈Çem r√≥wnie≈º obs≈Çugƒô bazy danych spot√≥w na mapie, kt√≥ra jest kluczowa dla Twojej aplikacji.

ZastƒÖp ca≈Çy skrypt (od `<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>` do ko≈Ñca pliku) poni≈ºszym kodem.

```javascript
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // === KRYTYCZNY BLOK: WPROWAD≈π SWOJE KLUCZE FIREBASE ===
        const firebaseConfig = {
            apiKey: "AIzaSyCCxW6X7MJlWPfxP_6I8FlLc7Vp2wiR69Q",
            authDomain: "skejspoty.firebaseapp.com",
            projectId: "skejspoty",
            storageBucket: "skejspoty.firebasestorage.app", // Poprawka nazwy
            messagingSenderId: "1067851773136",
            appId: "1:1067851773136:web:39bdc7f7af34cbbf94dad5",
            measurementId: "G-WH6DYL95DH"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage(); // Inicjalizacja Storage
        const spotsCollection = db.collection("spots");

        let currentUser = null;
        let map;
        let spotMarker = null; // Marker u≈ºywany do dodawania/edycji spot√≥w
        let allMarkers = {}; // Obiekt do przechowywania wszystkich marker√≥w na mapie
        let allSpotsData = []; // Tablica do przechowywania wszystkich danych spot√≥w
        let editSpotId = null; // ID edytowanego spota (null je≈õli dodajemy nowy)


        // --- FUNKCJA NOWEGO SYSTEMU POWIADOMIE≈É ---
        const notificationContainer = document.getElementById('notification-container');

        function showNotification(message, type = 'info', duration = 3500) {
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.innerHTML = message;

            notificationContainer.prepend(notif);

            gsap.fromTo(notif,
                { y: 50, opacity: 0 },
                { y: 0, opacity: 1, duration: 0.5, ease: "power2.out" }
            );

            gsap.to(notif, {
                delay: duration / 1000,
                y: 50,
                opacity: 0,
                duration: 0.5,
                ease: "power2.in",
                onComplete: () => {
                    notif.remove();
                }
            });
        }

        // --- PRZE≈ÅƒÑCZANIE SEKCEJI SIDEBAR NA MOBILE ---
        const authContent = document.getElementById('authContent');
        const spotsListContent = document.getElementById('spotsListContent');
        const mainSidebar = document.getElementById('mainSidebar');
        const mobileNav = document.getElementById('mobileNav');

        function isMobile() {
            return window.innerWidth <= 768;
        }

        function switchSidebarSection(target) {
            // Zamknij formularz dodawania/edycji, gdy prze≈ÇƒÖczasz sekcje
            toggleForm(false); 

            // Obs≈Çuga wy≈õwietlania paska bocznego na mobile
            if (isMobile()) {
                if (target === 'map') {
                    mainSidebar.classList.remove('active');
                } else {
                    mainSidebar.classList.add('active');
                }
            }
            
            // Prze≈ÇƒÖczanie sekcji
            authContent.classList.remove('active');
            spotsListContent.classList.remove('active');
            
            document.querySelectorAll('.mobile-nav .nav-item').forEach(item => item.classList.remove('active'));

            if (target === 'auth') {
                authContent.classList.add('active');
                document.getElementById('navKonto').classList.add('active');
            } else if (target === 'spotsList') {
                spotsListContent.classList.add('active');
                document.getElementById('navSpoty').classList.add('active');
            } else if (target === 'map') {
                document.getElementById('navMapa').classList.add('active');
            }
            // Upewnij siƒô, ≈ºe mapa poprawnie siƒô od≈õwie≈ºa po zamkniƒôciu sidebar (na desktopie)
            setTimeout(() => {
                if(map) map.invalidateSize();
            }, 500);
        }
        
        // Listenerzy do nawigacji mobilnej
        mobileNav.addEventListener('click', (e) => {
            const targetEl = e.target.closest('.nav-item');
            if (targetEl && targetEl.dataset.target) {
                switchSidebarSection(targetEl.dataset.target);
            }
        });

        // Domy≈õlny widok przy ≈Çadowaniu strony
        function initialView() {
            if (isMobile()) {
                 switchSidebarSection('map'); 
            } else {
                 switchSidebarSection('spotsList'); 
            }
        }
        initialView();


        // --- LOGIKA AUTORYZACJI ---
        const authStatusEl = document.getElementById('authStatus');
        const showLoginBtn = document.getElementById('showLoginBtn');
        const showRegisterBtn = document.getElementById('showRegisterBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginFormEl = document.getElementById('loginForm');
        const registerFormEl = document.getElementById('registerForm');
        const addSpotFab = document.getElementById('addSpotFab'); 
        const spotFormEl = document.getElementById('spot-form'); 

        // Funkcje do prze≈ÇƒÖczania formularzy autoryzacji
        showLoginBtn.onclick = () => {
            registerFormEl.style.display = 'none';
            loginFormEl.style.display = loginFormEl.style.display === 'block' ? 'none' : 'block';
        };

        showRegisterBtn.onclick = () => {
            loginFormEl.style.display = 'none';
            registerFormEl.style.display = registerFormEl.style.display === 'block' ? 'none' : 'block';
        };

        // Rejestracja
        async function handleRegister() {
            const nick = document.getElementById('registerNick').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            if (!nick || !email || !password) {
                return showNotification('Wype≈Çnij wszystkie pola!', 'error');
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await userCredential.user.updateProfile({ displayName: nick });
                showNotification(`Rejestracja udana! Witaj, ${nick}!`, 'success');
                registerFormEl.style.display = 'none';
            } catch (error) {
                console.error(error);
                showNotification(`B≈ÇƒÖd rejestracji: ${error.message}`, 'error');
            }
        }
        
        // Logowanie
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                await auth.signInWithEmailAndPassword(email, password);
                showNotification('Zalogowano pomy≈õlnie!', 'success');
                loginFormEl.style.display = 'none';
            } catch (error) {
                console.error(error);
                showNotification(`B≈ÇƒÖd logowania: ${error.message}`, 'error');
            }
        }

        // Wylogowanie
        logoutBtn.onclick = async () => {
            try {
                await auth.signOut();
                showNotification('Wylogowano pomy≈õlnie.', 'info');
            } catch (error) {
                console.error(error);
                showNotification(`B≈ÇƒÖd wylogowania: ${error.message}`, 'error');
            }
        };

        // Zapisanie funkcji do globalnego zasiƒôgu, aby dzia≈Ça≈Çy z atrybutem onclick w HTML
        window.handleRegister = handleRegister;
        window.handleLogin = handleLogin;
        
        // Obserwator stanu autoryzacji
        auth.onAuthStateChanged(async user => { 
            currentUser = user;

            if (user) {
                authStatusEl.innerHTML = `Zalogowano jako: <b>${user.displayName || user.email}</b>`;
                showLoginBtn.style.display = 'none';
                showRegisterBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                addSpotFab.style.display = 'flex'; 
            } else {
                authStatusEl.innerHTML = 'Niezalogowany. Zaloguj siƒô lub zarejestruj.';
                showLoginBtn.style.display = 'inline-block';
                showRegisterBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
                addSpotFab.style.display = 'none'; 
                toggleForm(false); 
            }
            loginFormEl.style.display = 'none';
            registerFormEl.style.display = 'none';
            
            // Renderuj spoty po zmianie statusu (mo≈ºliwo≈õƒá edycji/usuwania)
            fetchSpots(); 
        });

        // --- INICJALIZACJA MAPY LEAFLET ---
        function initMap() {
            map = L.map('map').setView([52.2297, 21.0122], 13); // Domy≈õlnie: Warszawa

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            // Listener na klikniƒôcie w mapƒô (tylko w trybie dodawania/edycji)
            map.on('click', (e) => {
                if (spotFormEl.style.display === 'block') {
                    placeMarker(e.latlng.lat, e.latlng.lng);
                    document.getElementById('spotLat').value = e.latlng.lat;
                    document.getElementById('spotLng').value = e.latlng.lng;
                    showNotification('Nowa lokalizacja spota zaznaczona!', 'info', 2000);
                }
            });
            
            // Zaznaczenie markera spota
            map.on('popupopen', (e) => {
                const spotId = e.popup._source.options.spotId;
                if (spotId) {
                    highlightSpotCard(spotId);
                }
            });

            map.on('popupclose', () => {
                highlightSpotCard(null);
            });


            fetchSpots(); // Pobierz spoty po inicjalizacji mapy
        }
        
        // Utw√≥rz nowy marker spota w trybie dodawania/edycji
        function placeMarker(lat, lng, iconType = 'add') {
            if (spotMarker) {
                map.removeLayer(spotMarker);
            }

            const markerIcon = L.divIcon({
                className: `custom-marker-icon ${iconType === 'add' ? 'pulsating-add' : 'pulsating-edit'}`, // Klasa do animacji
                html: 'üõπ', 
                iconSize: [40, 40],
                iconAnchor: [20, 40]
            });
            
            spotMarker = L.marker([lat, lng], { icon: markerIcon }).addTo(map);
        }


        // --- LOGIKA FORMULARZA DODAWANIA/EDYCYJI ---
        const saveSpotBtn = document.getElementById('saveSpotBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const editModeLabel = document.getElementById('editModeLabel');

        function resetForm() {
            document.getElementById('spotName').value = '';
            document.getElementById('spotDesc').value = '';
            document.getElementById('spotImageUpload').value = '';
            document.getElementById('spotBust').value = 'safe';
            document.getElementById('spotLights').checked = false;
            document.querySelectorAll('.spot-tag').forEach(cb => cb.checked = false);
            document.getElementById('spotLat').value = '';
            document.getElementById('spotLng').value = '';
            
            editSpotId = null;
            saveSpotBtn.innerHTML = 'ZAPISZ NA MAPIE';
            editModeLabel.style.display = 'none';
            cancelEditBtn.style.display = 'none';

            if (spotMarker) {
                map.removeLayer(spotMarker);
                spotMarker = null;
            }
        }
        
        // Otwiera/Zamyka formularz
        window.toggleForm = (show = null, data = null) => {
            if (show === null) {
                show = spotFormEl.style.display === 'none';
            }

            if (show) {
                if (!currentUser) {
                    return showNotification('Musisz byƒá zalogowany, aby dodawaƒá spoty!', 'error');
                }
                
                spotFormEl.style.display = 'block';
                addSpotFab.classList.add('form-active');
                
                // Tryb edycji
                if (data) {
                    editSpotId = data.id;
                    document.getElementById('spotName').value = data.name;
                    document.getElementById('spotDesc').value = data.description;
                    document.getElementById('spotBust').value = data.bustLevel || 'safe';
                    document.getElementById('spotLights').checked = data.hasLights || false;
                    
                    document.querySelectorAll('.spot-tag').forEach(cb => {
                        cb.checked = data.tags && data.tags.includes(cb.value);
                    });

                    document.getElementById('spotLat').value = data.lat;
                    document.getElementById('spotLng').value = data.lng;
                    
                    placeMarker(data.lat, data.lng, 'edit');
                    map.setView([data.lat, data.lng], 15);
                    
                    saveSpotBtn.innerHTML = 'AKTUALIZUJ SPOT';
                    editModeLabel.style.display = 'block';
                    cancelEditBtn.style.display = 'inline-block';
                    showNotification('Tryb edycji w≈ÇƒÖczony. Kliknij na mapƒô aby zmieniƒá pozycjƒô.', 'info', 3000);
                } else {
                    // Tryb dodawania nowego
                    resetForm();
                    showNotification('Kliknij na mapƒô, aby wybraƒá lokalizacjƒô spota.', 'info', 3000);
                }

                // Na mobile prze≈ÇƒÖcz na widok mapy, aby zaznaczyƒá punkt
                if (isMobile()) {
                    switchSidebarSection('map');
                }

            } else {
                resetForm();
                spotFormEl.style.display = 'none';
                addSpotFab.classList.remove('form-active');
            }
        }
        
        // Listener dla FABa
        addSpotFab.onclick = () => toggleForm();
        cancelEditBtn.onclick = () => toggleForm(false);

        // Zapisywanie spota
        saveSpotBtn.onclick = async () => {
            if (!currentUser) return showNotification('B≈ÇƒÖd: Wylogowano. Zaloguj siƒô ponownie.', 'error');
            
            const spotName = document.getElementById('spotName').value.trim();
            const spotDesc = document.getElementById('spotDesc').value.trim();
            const lat = document.getElementById('spotLat').value;
            const lng = document.getElementById('spotLng').value;
            const imageFile = document.getElementById('spotImageUpload').files[0];
            const bustLevel = document.getElementById('spotBust').value;
            const hasLights = document.getElementById('spotLights').checked;
            const selectedTags = Array.from(document.querySelectorAll('.spot-tag:checked')).map(cb => cb.value);

            if (!spotName || !lat || !lng) {
                return showNotification('Wype≈Çnij nazwƒô spota i wybierz lokalizacjƒô na mapie!', 'error');
            }

            let imageUrl = '';
            
            // Logika uploadu zdjƒôcia (tylko je≈õli dodajemy nowe lub jest nowe w trybie edycji)
            if (imageFile) {
                try {
                    showNotification('Przesy≈Çanie zdjƒôcia...', 'info', 5000);
                    const storageRef = storage.ref();
                    const imageRef = storageRef.child(`spot_images/${Date.now()}_${imageFile.name}`);
                    const snapshot = await imageRef.put(imageFile);
                    imageUrl = await snapshot.ref.getDownloadURL();
                    showNotification('Zdjƒôcie przes≈Çane!', 'success', 2000);
                } catch (error) {
                    console.error("B≈ÇƒÖd przesy≈Çania zdjƒôcia:", error);
                    showNotification('B≈ÇƒÖd przesy≈Çania zdjƒôcia. Spr√≥buj ponownie.', 'error');
                    return; 
                }
            }

            const spotData = {
                name: spotName,
                description: spotDesc,
                lat: parseFloat(lat),
                lng: parseFloat(lng),
                bustLevel: bustLevel,
                hasLights: hasLights,
                tags: selectedTags,
                uploaderId: currentUser.uid,
                uploaderNick: currentUser.displayName || currentUser.email,
                lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
            };

            // Dodaj URL do danych, je≈õli jest dostƒôpny
            if (imageUrl) {
                spotData.imageUrl = imageUrl;
            } else if (editSpotId) {
                // Je≈õli edytujemy, zachowaj stary URL, je≈õli nie przes≈Çano nowego
                const oldData = allSpotsData.find(s => s.id === editSpotId);
                if (oldData && oldData.imageUrl) {
                    spotData.imageUrl = oldData.imageUrl;
                }
            }

            try {
                if (editSpotId) {
                    await spotsCollection.doc(editSpotId).update(spotData);
                    showNotification('Spot zaktualizowany pomy≈õlnie!', 'success');
                } else {
                    await spotsCollection.add(spotData);
                    showNotification('Nowy spot dodany pomy≈õlnie!', 'success');
                }
                
                toggleForm(false); // Zamknij i zresetuj formularz
                fetchSpots(); // Od≈õwie≈º listƒô spot√≥w i mapƒô
            } catch (error) {
                console.error("B≈ÇƒÖd zapisu spota:", error);
                showNotification(`B≈ÇƒÖd zapisu: ${error.message}`, 'error');
            }
        };

        // --- OBS≈ÅUGA DANYCH SPOT√ìW (Pobieranie i Renderowanie) ---
        async function fetchSpots() {
            try {
                const snapshot = await spotsCollection.orderBy('lastUpdate', 'desc').get();
                allSpotsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSpots(getActiveFilters());
                updateMapMarkers();
            } catch (error) {
                console.error("B≈ÇƒÖd pobierania spot√≥w:", error);
                showNotification('B≈ÇƒÖd ≈Çadowania spot√≥w z bazy danych.', 'error');
            }
        }

        // Funkcja do mapowania poziomu przypa≈Çu na klasƒô CSS i tekst
        function getBustInfo(level) {
            switch (level) {
                case 'safe': return { text: 'Bezpiecznie (Chill)', class: 'bust-safe' };
                case 'medium': return { text: '≈öredni (Wbijaj szybko)', class: 'bust-medium' };
                case 'high': return { text: 'Du≈ºy (Ochrona goni)', class: 'bust-high' };
                default: return { text: 'Nieznany', class: 'bust-safe' };
            }
        }
        
        // Funkcja tworzƒÖca HTML dla karty spota
        function createSpotCardHTML(spot) {
            const bust = getBustInfo(spot.bustLevel);
            const isUploader = currentUser && currentUser.uid === spot.uploaderId;
            const lightsIcon = spot.hasLights ? '<i class="fas fa-lightbulb" style="color: var(--neon-orange); margin-left: 10px;"></i>' : '';

            return `
                <div class="spot-card" data-spot-id="${spot.id}" data-lat="${spot.lat}" data-lng="${spot.lng}">
                    <h3 style="color: var(--neon-blue);">${spot.name} ${lightsIcon}</h3>
                    <div class="bust-level ${bust.class}">${bust.text}</div>
                    ${spot.imageUrl ? `
                        <div class="spot-img-container" onclick="openLightbox('${spot.imageUrl}')">
                            <img src="${spot.imageUrl}" alt="${spot.name}" class="spot-img">
                        </div>
                    ` : ''}
                    <p style="margin: 10px 0; font-size: 0.9rem;">${spot.description || 'Brak opisu.'}</p>
                    <div class="tags-container">
                        ${(spot.tags || []).map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>
                    <p style="font-size: 0.75rem; color: #888; margin-top: 5px;">Dodano przez: ${spot.uploaderNick || 'Anonim'}</p>
                    <div class="card-actions">
                        <button class="card-btn" onclick="zoomToSpot('${spot.id}')" data-hover>üó∫Ô∏è Zobacz na Mapie</button>
                        ${isUploader ? `
                            <button class="card-btn" onclick="openEditForm('${spot.id}')" data-hover>‚úèÔ∏è Edytuj</button>
                            <button class="card-btn btn-red-card" onclick="deleteSpot('${spot.id}')" data-hover style="border-color: var(--neon-red); color: var(--neon-red);">üóëÔ∏è Usu≈Ñ</button>
                        ` : ''}
                    </div>
                    <div class="comments-section">
                        <h4 style="font-size: 0.9rem; color: var(--neon-pink);">Komentarze (0)</h4>
                        <p style="font-size: 0.75rem; color: #aaa;">Funkcjonalno≈õƒá komentarzy w budowie...</p>
                    </div>
                </div>
            `;
        }

        // --- FILTROWANIE SPOT√ìW ---
        function getActiveFilters() {
            const bustFilter = document.getElementById('filterBust').value;
            const tagFilters = Array.from(document.querySelectorAll('.filter-tag:checked')).map(cb => cb.value);
            return { bust: bustFilter, tags: tagFilters };
        }

        document.getElementById('applyFilterBtn').onclick = () => {
            renderSpots(getActiveFilters());
            updateMapMarkers(); // Aktualizacja widoczno≈õci marker√≥w na mapie
            showNotification('Filtry zastosowane!', 'info', 1500);
        };
        
        // Renderowanie listy spot√≥w
        function renderSpots(filters) {
            const spotsListEl = document.getElementById('spotsList');
            spotsListEl.innerHTML = '';
            
            const filteredSpots = allSpotsData.filter(spot => {
                // Filtr Poziom Przypa≈Çu
                const bustMatch = filters.bust === 'all' || spot.bustLevel === filters.bust;
                
                // Filtr Tagi
                const tagsMatch = filters.tags.length === 0 || 
                                 (spot.tags && filters.tags.every(tag => spot.tags.includes(tag)));
                
                return bustMatch && tagsMatch;
            });
            
            if (filteredSpots.length === 0) {
                spotsListEl.innerHTML = '<p style="padding: 20px; text-align: center; color: var(--neon-red);">Nie znaleziono spot√≥w spe≈ÇniajƒÖcych kryteria.</p>';
                document.getElementById('spotCount').textContent = 0;
                return;
            }
            
            filteredSpots.forEach(spot => {
                spotsListEl.innerHTML += createSpotCardHTML(spot);
            });
            
            document.getElementById('spotCount').textContent = filteredSpots.length;
        }

        // --- OBS≈ÅUGA MARKER√ìW NA MAPIE ---
        function updateMapMarkers() {
            if (!map) return;
            
            // Usu≈Ñ wszystkie istniejƒÖce markery
            Object.values(allMarkers).forEach(marker => map.removeLayer(marker));
            allMarkers = {};
            
            const filters = getActiveFilters();
            
            allSpotsData.forEach(spot => {
                const bustMatch = filters.bust === 'all' || spot.bustLevel === filters.bust;
                const tagsMatch = filters.tags.length === 0 || 
                                 (spot.tags && filters.tags.every(tag => spot.tags.includes(tag)));

                if (bustMatch && tagsMatch) {
                    const bustInfo = getBustInfo(spot.bustLevel);

                    const markerIcon = L.divIcon({
                        className: `custom-marker-icon marker-${spot.bustLevel}`,
                        html: '<i class="fas fa-skateboarding"></i>', 
                        iconSize: [35, 35],
                        iconAnchor: [17, 35]
                    });
                    
                    const marker = L.marker([spot.lat, spot.lng], { icon: markerIcon, spotId: spot.id }).addTo(map);
                    
                    // Zawarto≈õƒá PopUp (kr√≥tki opis i akcje)
                    const popupContent = `
                        <h4 style="color: var(--neon-blue);">${spot.name}</h4>
                        <p style="font-size: 0.9rem; margin-bottom: 10px;">Poziom: <span class="${bustInfo.class}">${bustInfo.text}</span></p>
                        <button class="card-btn" onclick="zoomToSpot('${spot.id}', true)" data-hover>Poka≈º Szczeg√≥≈Çy</button>
                    `;
                    
                    marker.bindPopup(popupContent, { offset: [0, -30] });
                    
                    allMarkers[spot.id] = marker;
                }
            });
        }
        
        // Akcja: Powiƒôksz do spota
        window.zoomToSpot = (spotId, openPopup = false) => {
            const spotCard = document.querySelector(`.spot-card[data-spot-id="${spotId}"]`);
            if (spotCard) {
                const lat = parseFloat(spotCard.dataset.lat);
                const lng = parseFloat(spotCard.dataset.lng);
                
                if (isNaN(lat) || isNaN(lng)) return;

                map.setView([lat, lng], 16);
                
                // Przewi≈Ñ sidebar do karty spota (tylko desktop/otwarty sidebar)
                if (!isMobile() || mainSidebar.classList.contains('active')) {
                     spotCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else {
                    // Na mobile prze≈ÇƒÖcz na widok mapy
                    switchSidebarSection('map');
                }

                // Otw√≥rz PopUp markera, je≈õli jest na mapie
                if (allMarkers[spotId]) {
                    allMarkers[spotId].openPopup();
                }

            }
        }
        
        // Pod≈õwietlanie karty spota w sidebar
        function highlightSpotCard(spotId) {
            document.querySelectorAll('.spot-card').forEach(card => {
                card.classList.remove('highlight');
            });
            if (spotId) {
                const card = document.querySelector(`.spot-card[data-spot-id="${spotId}"]`);
                if (card) {
                    card.classList.add('highlight');
                    // Upewnij siƒô, ≈ºe jest widoczny w przewijaniu
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        // Akcja: Otw√≥rz formularz edycji
        window.openEditForm = (spotId) => {
            const spotData = allSpotsData.find(s => s.id === spotId);
            if (spotData && currentUser && currentUser.uid === spotData.uploaderId) {
                toggleForm(true, spotData);
            } else {
                showNotification('Nie masz uprawnie≈Ñ do edycji tego spota.', 'error');
            }
        }
        
        // Akcja: Usu≈Ñ spot
        window.deleteSpot = async (spotId) => {
            const spotData = allSpotsData.find(s => s.id === spotId);
            if (!spotData || !currentUser || currentUser.uid !== spotData.uploaderId) {
                return showNotification('Nie masz uprawnie≈Ñ do usuniƒôcia tego spota.', 'error');
            }

            if (confirm('Jeste≈õ pewien, ≈ºe chcesz usunƒÖƒá ten spot? Ta akcja jest nieodwracalna!')) {
                try {
                    await spotsCollection.doc(spotId).delete();
                    // Opcjonalnie: Usu≈Ñ zdjƒôcie ze Storage, je≈õli istnieje
                    if (spotData.imageUrl) {
                        const imageRef = storage.refFromURL(spotData.imageUrl);
                        await imageRef.delete().catch(err => console.warn('B≈ÇƒÖd usuwania zdjƒôcia ze Storage:', err));
                    }
                    showNotification('Spot usuniƒôty pomy≈õlnie!', 'success');
                    fetchSpots(); 
                } catch (error) {
                    console.error("B≈ÇƒÖd usuwania spota:", error);
                    showNotification(`B≈ÇƒÖd usuwania: ${error.message}`, 'error');
                }
            }
        }

        // --- LIGHTBOX (Pe≈Çnoekranowe zdjƒôcie) ---
        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img');

        window.openLightbox = (src) => {
            lightboxImg.src = src;
            lightbox.style.display = 'flex';
            gsap.to(lightbox, { opacity: 1, duration: 0.3 });
        }

        window.closeLightbox = () => {
            gsap.to(lightbox, { opacity: 0, duration: 0.3, onComplete: () => {
                lightbox.style.display = 'none';
                lightboxImg.src = ''; 
            }});
        }

        // --- GEOLOKALIZACJA ---
        document.getElementById('locateUserBtn').onclick = () => {
            if (!navigator.geolocation) {
                return showNotification('Twoja przeglƒÖdarka nie wspiera geolokalizacji.', 'error');
            }
            
            showNotification('Lokalizowanie...', 'info', 3000);

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    map.setView([lat, lng], 15);
                    L.marker([lat, lng]).addTo(map).bindPopup("Twoja aktualna pozycja.").openPopup();
                    showNotification('Znaleziono TwojƒÖ pozycjƒô!', 'success', 2000);
                },
                (error) => {
                    console.error("Geolocation error:", error);
                    showNotification('Nie uda≈Ço siƒô ustaliƒá Twojej lokalizacji.', 'error');
                }
            );
        }

        // --- WYSZUKIWANIE MIAST (U≈ºycie geocoding API) ---
        document.getElementById('citySearchBtn').onclick = async () => {
            const query = document.getElementById('citySearchInput').value.trim();
            if (!query) return showNotification('Wpisz nazwƒô miejsca do wyszukania!', 'error');

            try {
                // U≈ºywamy OpenStreetMap Nominatim API do geokodowania
                const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`);
                const data = await response.json();

                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    map.setView([lat, lon], 13);
                    showNotification(`Znaleziono: ${data[0].display_name}`, 'success', 3000);
                } else {
                    showNotification('Nie znaleziono takiego miejsca.', 'error', 3000);
                }
            } catch (error) {
                console.error("B≈ÇƒÖd geokodowania:", error);
                showNotification('B≈ÇƒÖd wyszukiwania adresu.', 'error');
            }
        }

        // --- TRYB CIEMNY / JASNY ---
        window.toggleMode = () => {
            const body = document.body;
            body.classList.toggle('dark-mode');
            const isDarkMode = body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode);

            const modeBtn = document.getElementById('toggleModeBtn');
            const navMode = document.getElementById('navMode');

            if (isDarkMode) {
                modeBtn.innerHTML = '‚òÄÔ∏è Zmie≈Ñ Tryb';
                if (navMode) {
                    navMode.querySelector('i').className = 'fas fa-sun';
                    navMode.querySelector('span').textContent = 'Jasny';
                }
            } else {
                modeBtn.innerHTML = 'üåë Zmie≈Ñ Tryb';
                if (navMode) {
                    navMode.querySelector('i').className = 'fas fa-lightbulb';
                    navMode.querySelector('span').textContent = 'Tryb'; // Wracamy do Tryb, bo jest bardziej og√≥lne
                }
            }
            showNotification(isDarkMode ? 'W≈ÇƒÖczono Tryb Ciemny' : 'W≈ÇƒÖczono Tryb Jasny', 'info', 1500);
        }

        // Sprawd≈∫ preferencje trybu
        const savedMode = localStorage.getItem('darkMode');
        if (savedMode === 'true') {
            document.body.classList.add('dark-mode');
        }
        toggleMode(); // Uruchom, aby ustawiƒá poczƒÖtkowy tekst przycisku

        document.getElementById('toggleModeBtn').onclick = toggleMode;


        // --- CUSTOM CURSOR LOGIC ---
        const cursor = document.getElementById('cursor');
        document.addEventListener('mousemove', (e) => {
            gsap.to(cursor, { 
                x: e.clientX, 
                y: e.clientY, 
                duration: 0.1, 
                ease: "power2.out"
            });
        });

        document.querySelectorAll('[data-hover]').forEach(el => {
            el.addEventListener('mouseover', () => cursor.classList.add('hovered'));
            el.addEventListener('mouseout', () => cursor.classList.remove('hovered'));
        });

        // --- UKRYWANIE LOADERA PO ZA≈ÅADOWANIU WSZYSTKIEGO ---
        window.onload = () => {
            initMap(); // Inicjalizacja mapy Leaflet
            const loader = document.getElementById('loader');
            const appContainer = document.querySelector('.app-container');

            gsap.to(loader, { 
                opacity: 0, 
                duration: 0.5, 
                delay: 1, 
                onComplete: () => {
                    loader.style.display = 'none';
                    gsap.to(appContainer, { opacity: 1, duration: 0.5 });
                }
            });
        };
    </script>
