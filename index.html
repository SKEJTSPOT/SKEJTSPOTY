<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKEJTY - Mapa Spotów</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto+Mono:wght@300;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"> 
    
    <style>
        :root {
            --neon-green: #39ff14; --neon-pink: #ff00ff; --neon-blue: #00f3ff;
            --neon-red: #ff3131; --neon-orange: #ffaa00; --main-bg: #1a1a2e;
            --sidebar-bg: rgba(26, 26, 46, 0.98); --text-color: #f0f0f0;
            --card-bg: #2d2d4d; --form-bg: #3e3e6e; --shadow-color: rgba(0, 243, 255, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; cursor: none; }
        body { font-family: 'Orbitron', sans-serif; background-color: var(--main-bg); color: var(--text-color); overflow-x: hidden; height: 100vh; }
        
        #cursor { position: fixed; width: 20px; height: 20px; border: 2px solid var(--neon-pink); border-radius: 50%; pointer-events: none; z-index: 9999; transform: translate(-50%, -50%); transition: width 0.2s; mix-blend-mode: difference; }
        #cursor.hovered { width: 50px; height: 50px; background: rgba(255, 0, 255, 0.2); border-color: var(--neon-green); mix-blend-mode: normal; }

        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--main-bg); display: flex; justify-content: center; align-items: center; z-index: 10000; flex-direction: column; }
        .skate-wheel { width: 60px; height: 60px; border: 6px solid var(--neon-green); border-top: 6px solid var(--neon-pink); border-radius: 50%; animation: spin 0.6s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .app-container { display: grid; grid-template-columns: 400px 1fr; height: 100vh; opacity: 0; }
        .sidebar { background: var(--sidebar-bg); border-right: 2px solid var(--neon-pink); padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        #map-container { position: relative; width: 100%; height: 100%; }
        #map { width: 100%; height: 100%; }

        .btn-neon { font-family: 'Orbitron'; font-weight: bold; padding: 12px; margin: 5px 0; border: 2px solid; border-radius: 5px; cursor: pointer !important; background: transparent; color: inherit; width: 100%; transition: 0.3s; }
        .btn-green { border-color: var(--neon-green); color: var(--neon-green); }
        .btn-green:hover { background: var(--neon-green); color: black; }
        .btn-pink { border-color: var(--neon-pink); color: var(--neon-pink); }
        .btn-pink:hover { background: var(--neon-pink); color: white; }

        .spot-card { background: var(--card-bg); border: 2px solid var(--neon-pink); border-radius: 10px; padding: 15px; margin-bottom: 20px; }
        .gallery-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: thin; scrollbar-color: var(--neon-pink) transparent; }
        .gallery-img-wrapper { min-width: 180px; height: 120px; border: 1px solid var(--neon-blue); border-radius: 5px; overflow: hidden; flex-shrink: 0; }
        .gallery-img-wrapper img { width: 100%; height: 100%; object-fit: cover; }

        #spot-form { position: fixed; bottom: 80px; right: 20px; z-index: 2000; width: 350px; background: var(--form-bg); padding: 15px; border: 2px solid var(--neon-pink); display: none; }
        #spot-form input, #spot-form textarea, #spot-form select { width: 100%; padding: 8px; margin-bottom: 10px; background: #222; border: 1px solid var(--neon-blue); color: white; }
        
        .fab { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: var(--neon-pink); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; z-index: 2000; }

        #lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; justify-content: center; align-items: center; }
        #lightbox img { max-width: 90%; max-height: 90%; border: 2px solid white; }

        @media (max-width: 768px) {
            .app-container { grid-template-columns: 1fr; }
            .sidebar { position: fixed; bottom: 0; width: 100%; height: 50vh; z-index: 1500; transform: translateY(100%); transition: 0.5s; }
            .sidebar.active { transform: translateY(0); }
            #spot-form { width: 100%; right: 0; bottom: 0; }
        }
    </style>
</head>
<body class="dark-mode">
    <div id="cursor"></div>
    <div id="loader"><div class="skate-wheel"></div></div>
    <div id="lightbox" onclick="this.style.display='none'"><img id="lb-img"></div>

    <div class="app-container">
        <div class="sidebar" id="sidebar">
            <h1 style="color: var(--neon-blue); margin-bottom: 20px;">SKEJ<span style="color:var(--neon-pink)">TY</span></h1>
            <div id="authPanel">
                <div id="userStatus">Ładowanie...</div>
                <div id="authBtns">
                    <button class="btn-neon btn-green" onclick="showAuth('login')">ZALOGUJ</button>
                    <button class="btn-neon btn-pink" onclick="showAuth('reg')">REJESTRUJ</button>
                </div>
                <div id="loginForm" style="display:none;">
                    <input type="email" id="email" placeholder="Email">
                    <input type="password" id="pass" placeholder="Hasło">
                    <button class="btn-neon btn-green" onclick="handleAuth('login')">GO</button>
                </div>
            </div>
            <hr style="margin: 20px 0; border: 1px dashed var(--neon-blue);">
            <div id="spotsList"></div>
        </div>

        <div id="map-container">
            <div id="map"></div>
            <div class="fab" id="addBtn" onclick="toggleForm(true)" style="display:none;">+</div>

            <div id="spot-form">
                <h3 id="formTitle" style="color:var(--neon-orange); margin-bottom:10px;">DODAJ SPOT</h3>
                <input type="text" id="sName" placeholder="Nazwa spota">
                <textarea id="sDesc" placeholder="Opis..."></textarea>
                <select id="sBust">
                    <option value="safe">Bez przypału</option>
                    <option value="medium">Średni przypał</option>
                    <option value="high">Hardkor (Ochrona)</option>
                </select>
                
                <label style="font-size:0.7rem; color:var(--neon-blue)">ZDJĘCIA (MAX 3):</label>
                <input type="file" id="sImgInput" accept="image/*" multiple>
                <div id="previews" style="display:flex; gap:5px; margin-bottom:10px;"></div>

                <input type="hidden" id="sLat"><input type="hidden" id="sLng">
                <button class="btn-neon btn-green" onclick="saveSpot()">ZAPISZ</button>
                <button class="btn-neon" onclick="toggleForm(false)">ANULUJ</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // FIREBASE - WKLEJ SWOJE DANE TUTAJ!
        const firebaseConfig = {
            apiKey: "AIzaSyCCxW6X7MJlWPfxP_6I8FlLc7Vp2wiR69Q",
            authDomain: "skejspoty.firebaseapp.com",
            projectId: "skejspoty",
            storageBucket: "skejspoty.firebasestorage.app",
            messagingSenderId: "1067851773136",
            appId: "1:1067851773136:web:39bdc7f7af34cbbf94dad5"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let selectedImages = [];
        let editingId = null;
        let map, markers = [];

        // --- KOMPRESJA I OBSŁUGA ZDJĘĆ ---
        async function compressImg(file) {
            return new Promise(res => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX = 800;
                        let w = img.width, h = img.height;
                        if (w > MAX) { h *= MAX/w; w = MAX; }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        res(canvas.toDataURL('image/jpeg', 0.6));
                    };
                };
            });
        }

        document.getElementById('sImgInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files).slice(0, 3);
            const previewDiv = document.getElementById('previews');
            previewDiv.innerHTML = "Mielę foty...";
            selectedImages = [];
            for (const f of files) {
                const base64 = await compressImg(f);
                selectedImages.push({ data: base64, rot: 0 });
            }
            renderPreviews();
        });

        function renderPreviews() {
            const div = document.getElementById('previews');
            div.innerHTML = '';
            selectedImages.forEach((img, i) => {
                const item = document.createElement('div');
                item.style = "position:relative; width:60px; height:60px; border:1px solid var(--neon-blue)";
                item.innerHTML = `
                    <img src="${img.data}" style="width:100%; height:100%; object-fit:cover; transform:rotate(${img.rot}deg)">
                    <div onclick="rotateImg(${i})" style="position:absolute; bottom:0; background:blue; color:white; font-size:10px; cursor:pointer;">ROT</div>
                    <div onclick="removeImg(${i})" style="position:absolute; top:0; right:0; background:red; color:white; font-size:10px; cursor:pointer;">X</div>
                `;
                div.appendChild(item);
            });
        }
        window.rotateImg = (i) => { selectedImages[i].rot = (selectedImages[i].rot + 90) % 360; renderPreviews(); };
        window.removeImg = (i) => { selectedImages.splice(i, 1); renderPreviews(); };

        // --- MAPA ---
        function initMap() {
            map = L.map('map').setView([52.23, 21.01], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            map.on('click', e => {
                if (currentUser) {
                    document.getElementById('sLat').value = e.latlng.lat;
                    document.getElementById('sLng').value = e.latlng.lng;
                    toggleForm(true);
                }
            });
        }

        // --- LOGIKA SPOTÓW ---
        async function saveSpot() {
            const data = {
                name: document.getElementById('sName').value,
                desc: document.getElementById('sDesc').value,
                bust: document.getElementById('sBust').value,
                lat: parseFloat(document.getElementById('sLat').value),
                lng: parseFloat(document.getElementById('sLng').value),
                images: selectedImages,
                uid: currentUser.uid,
                time: firebase.firestore.FieldValue.serverTimestamp()
            };
            if (editingId) await db.collection('spots').doc(editingId).update(data);
            else await db.collection('spots').add(data);
            toggleForm(false);
        }

        function renderSpots(spots) {
            const list = document.getElementById('spotsList');
            list.innerHTML = '';
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            spots.forEach(s => {
                // Galeria
                let gal = '';
                if (s.images && s.images.length > 0) {
                    gal = '<div class="gallery-scroll">';
                    s.images.forEach(img => {
                        gal += `<div class="gallery-img-wrapper" onclick="openLB('${img.data}')">
                            <img src="${img.data}" style="transform:rotate(${img.rot || 0}deg)">
                        </div>`;
                    });
                    gal += '</div>';
                }

                const card = document.createElement('div');
                card.className = 'spot-card';
                card.innerHTML = `
                    <h3>${s.name}</h3>
                    <p>${s.desc}</p>
                    ${gal}
                    <div style="display:flex; gap:5px; margin-top:10px;">
                        <button class="btn-neon" onclick="map.setView([${s.lat},${s.lng}], 15)">MAPA</button>
                        ${currentUser && s.uid === currentUser.uid ? `<button class="btn-neon" onclick="editSpot('${s.id}')">EDYTUJ</button>` : ''}
                    </div>
                `;
                list.appendChild(card);

                const m = L.marker([s.lat, s.lng]).addTo(map).bindPopup(s.name);
                markers.push(m);
            });
        }

        window.openLB = (src) => { document.getElementById('lb-img').src = src; document.getElementById('lightbox').style.display = 'flex'; };

        window.editSpot = (id) => {
            const s = allSpots.find(x => x.id === id);
            editingId = id;
            document.getElementById('sName').value = s.name;
            document.getElementById('sDesc').value = s.desc;
            document.getElementById('sLat').value = s.lat;
            document.getElementById('sLng').value = s.lng;
            selectedImages = s.images || []; // Wczytujemy zdjęcia do edycji!
            renderPreviews();
            toggleForm(true);
        };

        function toggleForm(show) {
            document.getElementById('spot-form').style.display = show ? 'block' : 'none';
            if (!show) { editingId = null; selectedImages = []; renderPreviews(); }
        }

        // --- AUTH & START ---
        auth.onAuthStateChanged(user => {
            currentUser = user;
            document.getElementById('userStatus').innerText = user ? `Elo, ${user.email}` : "Wylogowany";
            document.getElementById('authBtns').style.display = user ? 'none' : 'block';
            document.getElementById('addBtn').style.display = user ? 'flex' : 'none';
        });

        window.showAuth = (type) => { document.getElementById('loginForm').style.display = 'block'; };
        window.handleAuth = (type) => {
            const e = document.getElementById('email').value, p = document.getElementById('pass').value;
            auth.signInWithEmailAndPassword(e, p);
        };

        let allSpots = [];
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            db.collection('spots').onSnapshot(snap => {
                allSpots = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                renderSpots(allSpots);
            });
            gsap.to('.app-container', { opacity: 1, duration: 1, delay: 1 });
            document.getElementById('loader').style.display = 'none';
        });

        // Cursor
        const cur = document.getElementById('cursor');
        document.addEventListener('mousemove', e => { cur.style.left = e.clientX+'px'; cur.style.top = e.clientY+'px'; });
    </script>
</body>
</html>
